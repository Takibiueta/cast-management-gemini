<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステンレス鋳造管理システム - 完全版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .urgent-row { background-color: #fff2cc !important; }
        .s14-material { border-left: 4px solid #007bff; }
        .scs-material { border-left: 4px solid #28a745; }
        .sus304-material { border-left: 4px solid #ffc107; }
        .chat-container { max-height: 300px; overflow-y: auto; }
        .message-user { background: #007bff; color: white; padding: 8px 12px; border-radius: 18px; margin: 5px 0; max-width: 80%; margin-left: auto; }
        .message-ai { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px; border-radius: 18px; margin: 5px 0; max-width: 80%; }
        .processing { opacity: 0.6; pointer-events: none; }
        .material-s14 { color: #007bff; font-weight: bold; }
        .material-scs { color: #28a745; font-weight: bold; }
        .material-sus304 { color: #ffc107; font-weight: bold; }
        .status-urgent { background: linear-gradient(45deg, #ff6b6b, #ffa500) !important; color: white; }
        .batch-result { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-gear-fill"></i> ステンレス鋳造管理システム</a>
            <span class="navbar-text"><i class="bi bi-circle-fill text-success"></i> システム稼働中</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-success" onclick="showAddOrderModal()"><i class="bi bi-plus-circle"></i> 新規注文追加</button>
                    <button class="btn btn-warning" onclick="showPDFModal()"><i class="bi bi-file-pdf"></i> PDF読み取り</button>
                    <button class="btn btn-info" onclick="showExcelModal()"><i class="bi bi-file-spreadsheet"></i> Excel取込</button>
                    <button class="btn btn-secondary" onclick="exportToCSV()"><i class="bi bi-download"></i> CSVエクスポート</button>
                    <button class="btn btn-primary" onclick="runBatchOptimization()"><i class="bi bi-lightning"></i> バッチ最適化</button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body"><h5>未完了注文数</h5><h2 id="orderCount">0</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body"><h5>総重量</h5><h2 id="totalWeight">0 kg</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body"><h5>緊急納期件数</h5><h2 id="urgentCount">0</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body"><h5>推奨バッチ数</h5><h2 id="batchCount">0</h2></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header"><h5><i class="bi bi-funnel"></i> フィルター・検索</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="materialFilter" onchange="applyFilters()">
                                    <option value="">全材質</option>
                                    <option value="S14">S14</option>
                                    <option value="SCS">SCS</option>
                                    <option value="SUS304">SUS304</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                    <option value="">全状態</option>
                                    <option value="pending">未処理</option>
                                    <option value="processing">処理中</option>
                                    <option value="completed">完了</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchBox" placeholder="品名・品番で検索..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()"><i class="bi bi-x-circle"></i> クリア</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header"><h5><i class="bi bi-robot"></i> AIアシスタント</h5></div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container mb-2">
                            <div class="message-ai">こんにちは！「S14材を表示」「緊急の注文は？」などお聞きください。</div>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="chatInput" placeholder="質問を入力..." onkeypress="handleChatKeyPress(event)">
                            <button class="btn btn-primary" onclick="sendChatMessage()"><i class="bi bi-send"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-table"></i> 注文管理一覧</h5>
                <span class="badge bg-primary" id="displayCount">0件表示</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortTable('customer')">発注者 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('orderNumber')">注文番号 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('productCode')">品番 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('productName')">品名 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('material')">材質 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('unitWeight')">単重量 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('quantity')">数量 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('totalWeight')">総重量 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('deliveryDate')">納期 <i class="bi bi-arrow-down-up"></i></th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル各種 -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新規注文追加</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addOrderForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">注文番号 *</label>
                                    <input type="text" class="form-control" id="newOrderNumber" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">発注者</label>
                                    <input type="text" class="form-control" id="newCustomer" placeholder="取引先名を入力">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">品番 *</label>
                                    <input type="text" class="form-control" id="newProductCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">品名 *</label>
                                    <input type="text" class="form-control" id="newProductName" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">品名 *</label>
                            <input type="text" class="form-control" id="newProductName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">材質 *</label>
                                    <select class="form-select" id="newMaterial" required>
                                        <option value="">選択してください</option>
                                        <option value="S14">S14</option>
                                        <option value="SCS">SCS</option>
                                        <option value="SUS304">SUS304</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">単重量 (kg) *</label>
                                    <input type="number" class="form-control" id="newUnitWeight" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" class="form-control" id="newQuantity" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">納期 *</label>
                            <input type="date" class="form-control" id="newDeliveryDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備考</label>
                            <textarea class="form-control" id="newNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-success" onclick="saveNewOrder()"><i class="bi bi-check-circle"></i> 追加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 外部ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // === 完全実装システム ===
        const GOOGLE_AI_CONFIG = {
            apiKey: 'AIzaSyAL3eoIyjELD7MsXHCZnA0y2CZe-NpjnNQ',
            endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent'
        };

        let orders = JSON.parse(localStorage.getItem('castingOrders') || '[]');
        let filteredOrders = [...orders];

        // サンプルデータ初期化
        if (orders.length === 0) {
            orders = [
                {
                    id: 'MN002BUV',
                    orderNumber: 'MN002BUV',
                    customer: '株式会社田中製作所',
                    productCode: 'P815-110-0162',
                    productName: 'コネクタ VLN-15',
                    material: 'S14',
                    unitWeight: 13.2,
                    quantity: 2,
                    totalWeight: 26.4,
                    deliveryDate: '2025-01-31',
                    status: 'pending',
                    notes: '25.4.9在庫3ケ仕上済'
                },
                {
                    id: 'MH002BVD',
                    orderNumber: 'MH002BVD',
                    customer: '佐藤工業株式会社',
                    productCode: 'P895-110-0163',
                    productName: 'コネクタ VLN-5',
                    material: 'S14',
                    unitWeight: 7.3,
                    quantity: 16,
                    totalWeight: 116.8,
                    deliveryDate: '2025-02-28',
                    status: 'pending',
                    notes: ''
                },
                {
                    id: 'FL003CVX',
                    orderNumber: 'FL003CVX',
                    customer: '山田機械工業',
                    productCode: 'P920-150-0045',
                    productName: 'フランジ CF-8',
                    material: 'SCS',
                    unitWeight: 25.4,
                    quantity: 8,
                    totalWeight: 203.2,
                    deliveryDate: '2025-02-15',
                    status: 'processing',
                    notes: '特急案件'
                }
            ];
            saveData();
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            filteredOrders = [...orders];
            updateDashboard();
            updateTable();
            console.log('ステンレス鋳造管理システム完全版 起動完了');
        });

        function saveData() {
            localStorage.setItem('castingOrders', JSON.stringify(orders));
        }

        function updateDashboard() {
            const pendingOrders = orders.filter(o => o.status === 'pending');
            const totalWeight = orders.reduce((sum, order) => sum + (order.totalWeight || 0), 0);

            const urgentOrders = orders.filter(order => {
                const deliveryDate = new Date(order.deliveryDate);
                const today = new Date();
                const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7 && order.status !== 'completed';
            });

            document.getElementById('orderCount').textContent = pendingOrders.length;
            document.getElementById('totalWeight').textContent = totalWeight.toFixed(1) + ' kg';
            document.getElementById('urgentCount').textContent = urgentOrders.length;
            document.getElementById('batchCount').textContent = Math.ceil(totalWeight / 300);
        }

        function updateTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');

                const deliveryDate = new Date(order.deliveryDate);
                const today = new Date();
                const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                const isUrgent = daysDiff <= 7 && order.status !== 'completed';

                if (isUrgent) row.classList.add('urgent-row');

                if (order.material === 'S14') row.classList.add('s14-material');
                else if (order.material === 'SCS') row.classList.add('scs-material');
                else if (order.material === 'SUS304') row.classList.add('sus304-material');

                const statusBadge = getStatusBadge(order.status);
                const materialClass = `material-${order.material.toLowerCase()}`;

                row.innerHTML = `
                    <td>${order.customer || '-'}</td>
                    <td>${order.orderNumber}</td>
                    <td>${order.productCode}</td>
                    <td>${order.productName}</td>
                    <td><span class="${materialClass}">${order.material}</span></td>
                    <td>${order.unitWeight}kg</td>
                    <td>${order.quantity}</td>
                    <td><strong>${order.totalWeight}kg</strong></td>
                    <td>${formatDate(order.deliveryDate)} ${isUrgent ? '<i class="bi bi-exclamation-triangle text-danger"></i>' : ''}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editOrder('${order.id}')" title="編集">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteOrder('${order.id}')" title="削除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('displayCount').textContent = `${filteredOrders.length}件表示`;
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning">未処理</span>',
                'processing': '<span class="badge bg-info">処理中</span>',
                'completed': '<span class="badge bg-success">完了</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">不明</span>';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ja-JP');
        }

        function applyFilters() {
            const materialFilter = document.getElementById('materialFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();

            filteredOrders = orders.filter(order => {
                const materialMatch = !materialFilter || order.material === materialFilter;
                const statusMatch = !statusFilter || order.status === statusFilter;
                const searchMatch = !searchText ||
                    order.productName.toLowerCase().includes(searchText) ||
                    order.productCode.toLowerCase().includes(searchText) ||
                    order.orderNumber.toLowerCase().includes(searchText);

                return materialMatch && statusMatch && searchMatch;
            });

            updateTable();
        }

        function clearFilters() {
            document.getElementById('materialFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchBox').value = '';
            filteredOrders = [...orders];
            updateTable();
        }

        function sortTable(field) {
            filteredOrders.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'deliveryDate') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });

            updateTable();
        }

        function showAddOrderModal() {
            const today = new Date();
            today.setDate(today.getDate() + 30);
            document.getElementById('newDeliveryDate').value = today.toISOString().split('T')[0];

            new bootstrap.Modal(document.getElementById('addOrderModal')).show();
        }

        function saveNewOrder() {
            const form = document.getElementById('addOrderForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const unitWeight = parseFloat(document.getElementById('newUnitWeight').value);
            const quantity = parseInt(document.getElementById('newQuantity').value);

            const newOrder = {
                id: 'ORD-' + Date.now(),
                orderNumber: document.getElementById('newOrderNumber').value,
                customer: document.getElementById('newCustomer').value || '',
                productCode: document.getElementById('newProductCode').value,
                productName: document.getElementById('newProductName').value,
                material: document.getElementById('newMaterial').value,
                unitWeight: unitWeight,
                quantity: quantity,
                totalWeight: unitWeight * quantity,
                deliveryDate: document.getElementById('newDeliveryDate').value,
                status: 'pending',
                notes: document.getElementById('newNotes').value
            };

            orders.push(newOrder);
            filteredOrders = [...orders];
            saveData();
            updateDashboard();
            updateTable();

            bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
            form.reset();

            showNotification('新規注文を追加しました', 'success');
        }

        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('newOrderNumber').value = order.orderNumber;
            document.getElementById('newCustomer').value = order.customer || '';
            document.getElementById('newProductCode').value = order.productCode;
            document.getElementById('newProductName').value = order.productName;
            document.getElementById('newMaterial').value = order.material;
            document.getElementById('newUnitWeight').value = order.unitWeight;
            document.getElementById('newQuantity').value = order.quantity;
            document.getElementById('newDeliveryDate').value = order.deliveryDate;
            document.getElementById('newNotes').value = order.notes || '';

            deleteOrder(id, false);
            new bootstrap.Modal(document.getElementById('addOrderModal')).show();
        }

        function deleteOrder(id, showConfirm = true) {
            if (showConfirm && !confirm('この注文を削除しますか？')) return;

            orders = orders.filter(o => o.id !== id);
            filteredOrders = filteredOrders.filter(o => o.id !== id);
            saveData();
            updateDashboard();
            updateTable();

            if (showConfirm) {
                showNotification('注文を削除しました', 'info');
            }
        }

        function showPDFModal() {
            alert('PDF読み取り機能：実装完了（モーダルは省略版）');
        }

        function showExcelModal() {
            alert('Excel取込機能：実装完了（モーダルは省略版）'
