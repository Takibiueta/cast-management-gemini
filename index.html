<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステンレス鋳造管理システム - 完全版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .urgent-row { background-color: #fff2cc !important; }
        .s14-material { border-left: 4px solid #007bff; }
        .scs-material { border-left: 4px solid #28a745; }
        .sus304-material { border-left: 4px solid #ffc107; }
        .chat-container { max-height: 300px; overflow-y: auto; }
        .message-user { background: #007bff; color: white; padding: 8px 12px; border-radius: 18px; margin: 5px 0; max-width: 80%; margin-left: auto; }
        .message-ai { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px; border-radius: 18px; margin: 5px 0; max-width: 80%; }
        .processing { opacity: 0.6; pointer-events: none; }
        .material-s14 { color: #007bff; font-weight: bold; }
        .material-scs { color: #28a745; font-weight: bold; }
        .material-sus304 { color: #ffc107; font-weight: bold; }
        .status-urgent { background: linear-gradient(45deg, #ff6b6b, #ffa500) !important; color: white; }
        .batch-result { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin: 10px 0; }
        
        /* PDF自動入力フォーム用スタイル */
        .auto-filled {
            background-color: #e8f4f8 !important;
            border-left: 3px solid #17a2b8 !important;
            transition: all 0.3s ease;
        }
        
        .auto-filled:focus {
            background-color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25) !important;
        }
        
        .form-control.is-valid {
            border-color: #198754;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.4.4c.2.2.6.2.8 0l3.1-3.1c.2-.2.2-.6 0-.8L5.6 2.22c-.2-.2-.6-.2-.8 0l-1.8 1.8L1.7 2.7c-.2-.2-.6-.2-.8 0L.22 3.4c-.2.2-.2.6 0 .8l2.08 2.53z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m6 3v3m0 2h.01'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .extraction-summary {
            animation: slideIn 0.5s ease-in-out;
        }
        
        .data-preview-table th {
            width: 30%;
            font-weight: 600;
            color: #495057;
        }
        
        .data-preview-table td {
            color: #6c757d;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-animated .progress-bar {
            animation: progressFill 1s ease-in-out;
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: var(--progress-width); }
        }
    </style>
    
    <script>
        // === AIチャット機能（グローバル関数） ===
        let isProcessing = false;
        let orders = [];
        let filteredOrders = [];
        
        // 製品データと取引先データ
        let products = [];
        let customers = [];
        let filteredProducts = [];
        let filteredCustomers = [];
        
        // クイッククエリ挿入
        function insertQuickQuery(query) {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = query;
            }
        }

        // チャットメッセージ送信
        async function sendChatMessage() {
            if (isProcessing) return;

            const input = document.getElementById('chatInput');
            const message = input ? input.value.trim() : '';
            
            if (!message) {
                alert('メッセージを入力してください');
                return;
            }

            // ユーザーメッセージを表示
            addMessageToChat(message, 'user');
            input.value = '';
            
            // 処理中状態に設定
            setProcessingState(true);

            try {
                // 自然言語でデータ検索を実行
                const searchResult = await processNaturalLanguageQuery(message);
                
                // AI APIを呼び出し
                const aiResponse = await callAIAPI(message, searchResult);
                
                // AIレスポンスを表示
                addMessageToChat(aiResponse, 'ai');
                
            } catch (error) {
                console.error('AI処理エラー:', error);
                addMessageToChat('申し訳ございません。処理中にエラーが発生しました。もう一度お試しください。', 'ai');
            } finally {
                setProcessingState(false);
            }
        }

        // Enter キー処理
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // チャットにメッセージを追加
        function addMessageToChat(message, type) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'user' ? 'message-user' : 'message-ai';
            messageDiv.innerHTML = message.replace(/\n/g, '<br>');
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 処理中状態の設定
        function setProcessingState(processing) {
            isProcessing = processing;
            const sendButton = document.getElementById('sendButton');
            const chatInput = document.getElementById('chatInput');
            
            if (processing) {
                if (sendButton) {
                    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 処理中...';
                    sendButton.disabled = true;
                }
                if (chatInput) {
                    chatInput.disabled = true;
                }
                addMessageToChat('<div class="text-muted"><i class="bi bi-hourglass-split"></i> AIが回答を生成中...</div>', 'ai');
            } else {
                if (sendButton) {
                    sendButton.innerHTML = '<i class="bi bi-send"></i> 送信';
                    sendButton.disabled = false;
                }
                if (chatInput) {
                    chatInput.disabled = false;
                }
                // 処理中メッセージを削除
                const messages = document.querySelectorAll('.message-ai');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage && lastMessage.innerHTML.includes('hourglass-split')) {
                    lastMessage.remove();
                }
            }
        }

        // 自然言語クエリ処理
        async function processNaturalLanguageQuery(query) {
            const normalizedQuery = query.toLowerCase();
            let filteredData = [...orders];
            let searchResults = {
                data: filteredData,
                summary: '',
                filters: []
            };

            try {
                // 材質フィルタリング
                if (normalizedQuery.includes('s14')) {
                    filteredData = filteredData.filter(order => order.material === 'S14');
                    searchResults.filters.push('S14材');
                } else if (normalizedQuery.includes('scs')) {
                    filteredData = filteredData.filter(order => order.material === 'SCS');
                    searchResults.filters.push('SCS材');
                } else if (normalizedQuery.includes('sus304')) {
                    filteredData = filteredData.filter(order => order.material === 'SUS304');
                    searchResults.filters.push('SUS304材');
                }

                // 緊急案件フィルタリング
                if (normalizedQuery.includes('緊急') || normalizedQuery.includes('急ぎ')) {
                    const urgentOrders = filteredData.filter(order => {
                        const deliveryDate = new Date(order.deliveryDate);
                        const today = new Date();
                        const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                        return daysDiff <= 7 && order.status !== 'completed';
                    });
                    filteredData = urgentOrders;
                    searchResults.filters.push('緊急案件');
                }

                // 統計情報の生成
                if (normalizedQuery.includes('重量') || normalizedQuery.includes('総重量')) {
                    const totalWeight = filteredData.reduce((sum, order) => sum + order.totalWeight, 0);
                    searchResults.summary = `総重量: ${totalWeight.toFixed(1)}kg`;
                }

                searchResults.data = filteredData;

                // 検索結果をテーブルに反映（関数が存在する場合のみ）
                if (typeof updateTable === 'function' && filteredData.length !== orders.length) {
                    filteredOrders = filteredData;
                    updateTable();
                }

                return searchResults;

            } catch (error) {
                console.error('自然言語処理エラー:', error);
                return { data: orders, summary: 'データ処理中にエラーが発生しました', filters: [] };
            }
        }

        // メインAI API呼び出し関数
        async function callAIAPI(message, context) {
            return generateLocalResponse(message, context);
        }

        // ローカル処理での回答生成
        function generateLocalResponse(message, context) {
            const { data, summary, filters } = context;
            const normalizedQuery = message.toLowerCase();

            if (filters.length > 0) {
                let response = `${filters.join('、')}の検索結果をお見せしています。\n\n`;
                
                if (data.length === 0) {
                    response += '該当する注文はありませんでした。';
                } else {
                    response += `${data.length}件の注文が見つかりました。\n`;
                    
                    if (summary) {
                        response += summary + '\n';
                    }
                    
                    // トップ3の注文を表示
                    const topOrders = data.slice(0, 3);
                    response += '\n主な注文:\n';
                    topOrders.forEach((order, index) => {
                        response += `${index + 1}. ${order.productName} (${order.material}) - ${order.totalWeight}kg\n`;
                    });
                    
                    if (data.length > 3) {
                        response += `\n他 ${data.length - 3}件の注文があります。`;
                    }
                }
                
                return response;
            } else if (normalizedQuery.includes('こんにちは') || normalizedQuery.includes('はじめまして')) {
                return 'こんにちは！ステンレス鋳造管理システムのAIアシスタントです。\n\n以下のような質問にお答えできます：\n• "S14材を表示" - 特定材質の検索\n• "緊急の注文は？" - 緊急案件の確認\n• "総重量を教えて" - 統計情報の表示\n\nお気軽にお聞きください！';
            } else if (normalizedQuery.includes('ありがとう')) {
                return 'どういたしまして！他にもご質問があればお気軽にお聞きください。';
            } else {
                return `「${message}」についてお答えします。\n\n現在 ${orders.length}件の注文を管理中です。具体的な検索を行う場合は、以下のようにお聞きください：\n• 材質指定: "S14材を表示"\n• 緊急度: "緊急の注文は？"\n• 統計情報: "総重量を教えて"`;
            }
        }

        // === 共通データ管理関数 ===
        function saveData() {
            try {
                localStorage.setItem('castingOrders', JSON.stringify(orders));
                console.log('データ保存完了');
            } catch (error) {
                console.error('データ保存エラー:', error);
            }
        }

        function saveProductData() {
            try {
                localStorage.setItem('castingProducts', JSON.stringify(products));
                console.log('製品データ保存完了');
            } catch (error) {
                console.error('製品データ保存エラー:', error);
            }
        }

        function saveCustomerData() {
            try {
                localStorage.setItem('castingCustomers', JSON.stringify(customers));
                console.log('取引先データ保存完了');
            } catch (error) {
                console.error('取引先データ保存エラー:', error);
            }
        }

        function loadAllData() {
            try {
                orders = JSON.parse(localStorage.getItem('castingOrders') || '[]');
                products = JSON.parse(localStorage.getItem('castingProducts') || '[]');
                customers = JSON.parse(localStorage.getItem('castingCustomers') || '[]');
                filteredOrders = [...orders];
                filteredProducts = [...products];
                filteredCustomers = [...customers];
                console.log('全データ読み込み完了');
            } catch (error) {
                console.error('データ読み込みエラー:', error);
            }
        }

        function updateDashboard() {
            try {
                const pendingOrders = orders.filter(o => o.status === 'pending');
                const totalWeight = orders.reduce((sum, order) => sum + (order.totalWeight || 0), 0);
                const urgentOrders = orders.filter(o => {
                    const deliveryDate = new Date(o.deliveryDate);
                    const today = new Date();
                    const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                    return daysDiff <= 7 && o.status !== 'completed';
                });

                // 正しいIDに修正
                const orderCountElement = document.getElementById('orderCount');
                const totalWeightElement = document.getElementById('totalWeight');
                const urgentCountElement = document.getElementById('urgentCount');
                const batchCountElement = document.getElementById('batchCount');

                if (orderCountElement) orderCountElement.textContent = pendingOrders.length;
                if (totalWeightElement) totalWeightElement.textContent = totalWeight.toFixed(1) + ' kg';
                if (urgentCountElement) urgentCountElement.textContent = urgentOrders.length;
                if (batchCountElement) batchCountElement.textContent = Math.ceil(totalWeight / 300);
                
                console.log('ダッシュボード更新完了');
            } catch (error) {
                console.error('ダッシュボード更新エラー:', error);
            }
        }

        function updateTable() {
            try {
                const tbody = document.getElementById('ordersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                filteredOrders.forEach(order => {
                    const row = document.createElement('tr');

                    const deliveryDate = new Date(order.deliveryDate);
                    const today = new Date();
                    const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                    const isUrgent = daysDiff <= 7 && order.status !== 'completed';

                    if (isUrgent) row.classList.add('urgent-row');

                    if (order.material === 'S14') row.classList.add('s14-material');
                    else if (order.material === 'SCS') row.classList.add('scs-material');
                    else if (order.material === 'SUS304') row.classList.add('sus304-material');

                    const statusBadge = getStatusBadge(order.status);
                    const materialClass = `material-${order.material.toLowerCase()}`;

                    row.innerHTML = `
                        <td>${order.customer || '-'}</td>
                        <td>${order.orderNumber}</td>
                        <td>${order.productCode}</td>
                        <td>${order.productName}</td>
                        <td><span class="${materialClass}">${order.material}</span></td>
                        <td>${order.unitWeight}kg</td>
                        <td>${order.quantity}</td>
                        <td><strong>${order.totalWeight}kg</strong></td>
                        <td>${order.orderDate ? formatDate(order.orderDate) : '-'}</td>
                        <td>${formatDate(order.deliveryDate)} ${isUrgent ? '<i class="bi bi-exclamation-triangle text-danger"></i>' : ''}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editOrder('${order.id}')" title="編集">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteOrder('${order.id}')" title="削除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                const displayCountElement = document.getElementById('displayCount');
                if (displayCountElement) {
                    displayCountElement.textContent = `${filteredOrders.length}件表示`;
                }
                console.log('テーブル更新完了');
            } catch (error) {
                console.error('テーブル更新エラー:', error);
            }
        }

        // 補助関数
        function getStatusBadge(status) {
            const styles = {
                pending: 'bg-orange-500 text-white',
                processing: 'bg-blue-500 text-white',
                completed: 'bg-green-500 text-white'
            };
            
            const labels = {
                pending: '未着手',
                processing: '進行中',
                completed: '完了'
            };

            return `<span class="badge ${styles[status] || 'bg-gray-500 text-white'}">${labels[status] || status}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ja-JP');
            } catch (error) {
                return dateStr;
            }
        }

        // === PDF機能（グローバル関数） ===
        let currentPDF = null;
        let currentPage = 1;

        // PDFモーダル表示
        function showPDFModal() {
            resetPDFModal();
            const modal = new bootstrap.Modal(document.getElementById('pdfModal'));
            modal.show();
        }

        // PDFモーダルリセット
        function resetPDFModal() {
            const pdfFileInput = document.getElementById('pdfFileInput');
            const pdfProcessingStatus = document.getElementById('pdfProcessingStatus');
            const pdfPreview = document.getElementById('pdfPreview');
            const extractedDataContainer = document.getElementById('extractedDataContainer');
            const noDataMessage = document.getElementById('noDataMessage');
            const extractedText = document.getElementById('extractedText');
            const addFromPDFBtn = document.getElementById('addFromPDFBtn');
            const pdfExtractedForm = document.getElementById('pdfExtractedForm');

            if (pdfFileInput) pdfFileInput.value = '';
            if (pdfProcessingStatus) pdfProcessingStatus.classList.add('d-none');
            if (pdfPreview) pdfPreview.classList.add('d-none');
            if (extractedDataContainer) extractedDataContainer.classList.add('d-none');
            if (noDataMessage) noDataMessage.classList.remove('d-none');
            if (extractedText) extractedText.value = '';
            if (addFromPDFBtn) {
                addFromPDFBtn.disabled = true;
                addFromPDFBtn.innerHTML = '<i class="bi bi-plus-circle"></i> 注文として追加';
                addFromPDFBtn.title = 'PDFを読み込んでから使用してください';
            }
            if (pdfExtractedForm) pdfExtractedForm.reset();

            currentPDF = null;
            currentPage = 1;
        }

        // PDFファイル選択処理
        async function handlePDFFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('PDFファイルを選択してください。');
                return;
            }

            try {
                // 処理中表示
                const pdfProcessingStatus = document.getElementById('pdfProcessingStatus');
                const noDataMessage = document.getElementById('noDataMessage');
                
                if (pdfProcessingStatus) pdfProcessingStatus.classList.remove('d-none');
                if (noDataMessage) noDataMessage.classList.add('d-none');

                // PDF.jsの確認と設定
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.jsライブラリが読み込まれていません');
                }

                // PDF.js Worker設定（警告解消）
                if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }

                // PDFを読み込み
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                currentPDF = pdf;

                // 最初のページを表示
                await renderPDFPage(1);

                // テキスト抽出（ページ別）
                const pagesData = await extractTextFromPDF(pdf);
                
                // 各ページのデータを抽出
                for (let pageData of pagesData) {
                    pageData.extractedData = extractDataFromText(pageData.text);
                    console.log(`ページ${pageData.pageNumber}の抽出結果:`, pageData.extractedData);
                }

                // 複数ページ表示の生成
                displayMultiPageResults(pagesData);

                // UI更新
                if (pdfProcessingStatus) pdfProcessingStatus.classList.add('d-none');
                const pdfPreview = document.getElementById('pdfPreview');
                const extractedDataContainer = document.getElementById('extractedDataContainer');
                
                if (pdfPreview) pdfPreview.classList.remove('d-none');
                if (extractedDataContainer) extractedDataContainer.classList.remove('d-none');
                if (noDataMessage) noDataMessage.classList.add('d-none');

                // 右下の一括追加ボタンを有効化
                const addFromPDFBtn = document.getElementById('addFromPDFBtn');
                if (addFromPDFBtn) {
                    addFromPDFBtn.disabled = false;
                    addFromPDFBtn.innerHTML = '<i class="bi bi-upload"></i> 全ページ一括追加';
                    addFromPDFBtn.title = `${pagesData.length}ページを一括でシステムに追加します`;
                }

                // フォーム監視機能を初期化
                setupFormWatchers();

            } catch (error) {
                console.error('PDF処理エラー:', error);
                alert('PDFの処理中にエラーが発生しました：' + error.message);
                const pdfProcessingStatus = document.getElementById('pdfProcessingStatus');
                if (pdfProcessingStatus) pdfProcessingStatus.classList.add('d-none');
            }
        }

        // PDFページレンダリング
        async function renderPDFPage(pageNumber) {
            if (!currentPDF) return;

            try {
                const page = await currentPDF.getPage(pageNumber);
                const canvas = document.getElementById('pdfCanvas');
                if (!canvas) return;
                
                const context = canvas.getContext('2d');
                const containerWidth = canvas.parentElement.clientWidth - 40;
                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;

                await page.render({
                    canvasContext: context,
                    viewport: scaledViewport
                }).promise;

                const pdfPageInfo = document.getElementById('pdfPageInfo');
                if (pdfPageInfo) {
                    pdfPageInfo.textContent = `${pageNumber} / ${currentPDF.numPages}`;
                }

            } catch (error) {
                console.error('ページレンダリングエラー:', error);
            }
        }

        // PDFテキスト抽出（ページ別対応）
        async function extractTextFromPDF(pdf) {
            const pagesData = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                try {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    // ページごとのデータを格納
                    pagesData.push({
                        pageNumber: i,
                        text: pageText,
                        extractedData: null // 後で抽出データを格納
                    });
                    
                    console.log(`ページ${i}のテキスト長:`, pageText.length);
                } catch (error) {
                    console.error(`ページ ${i} のテキスト抽出エラー:`, error);
                }
            }

            return pagesData;
        }

        // 改善されたデータ抽出機能
        function extractDataFromText(text) {
            const data = {
                orderNumber: '',
                customer: '',
                productCode: '',
                productName: '',
                material: '',
                unitWeight: '',
                quantity: '',
                orderDate: '',      // 発注日を追加
                deliveryDate: '',
                notes: ''
            };

            try {
                console.log('=== PDF解析開始 ===');
                console.log('抽出テキスト（全体）:', text.substring(0, 1000) + '...');
                console.log('テキスト長:', text.length);
                
                // 行別デバッグ出力
                const lines = text.split('\n');
                console.log('行数:', lines.length);
                lines.forEach((line, index) => {
                    if (line.trim() && index < 20) { // 最初の20行のみ表示
                        console.log(`行${index + 1}: "${line}"`);
                    }
                });

                // 1. 注文番号抽出 - 受注番号、注文番号の様々なパターン
                const orderPatterns = [
                    /受注N[09][:：]?\s*(\d+)/i,                    // 受注N9：12345
                    /受注番号[:：]\s*([A-Z0-9\-]+)/i,              // 受注番号：ABC123
                    /注文番?号[:：\s]*([A-Z0-9\-]+)/i,             // 注文番号：123-456
                    /Order\s*No\.?\s*[:：]?\s*([A-Z0-9\-]+)/i,    // Order No: ORD123
                    /発注番?号[:：\s]*([A-Z0-9\-\s]+)/i,           // 発注番号：39 83 81 (スペース含む)
                    /発注№[:：\s]*([A-Z0-9\-\s]+)/i,               // 発注№：39 83 81
                    /NO\.?\s*[:：]?\s*([A-Z0-9\-]+)/i,            // NO: 123456
                    /管理番号[:：\s]*([A-Z0-9\-]+)/i,              // 管理番号：MGT123
                    /([0-9]{8})/g,                                // 8桁の数字 (00000142)
                    /([0-9]{2}\s+[0-9]{2}\s+[0-9]{2})/g,         // スペース区切りの番号 (39 83 81)
                    /(\d{8})/g,                                   // 8桁連続数字の改良版
                    /([0-9]+\s+[0-9]+\s+[0-9]+)/g,               // 複数桁スペース区切り番号
                    /^[\s]*([0-9]{8,})[\s]*$/m,                  // 行頭から8桁以上の数字
                    /発注\s*№?\s*[:：]?\s*([A-Z0-9\-\s]+?)[\s\n]/i, // 発注№の改良版
                    /受注\s*N[Oo0]?\s*[:：]?\s*([A-Z0-9\-\s]+?)[\s\n]/i // 受注No の改良版
                ];
                
                for (let i = 0; i < orderPatterns.length; i++) {
                    const pattern = orderPatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.orderNumber = match[1].trim();
                        console.log(`注文番号抽出（パターン${i+1}）:`, data.orderNumber, 'マッチ:', match[0]);
                        break;
                    } else if (i < 5) { // 最初の5パターンのみデバッグ出力
                        console.log(`注文番号パターン${i+1}マッチなし:`, pattern);
                    }
                }

                // 2. 発注者抽出 - 注文者、発注者、会社名
                const customerPatterns = [
                    /注文者[:：\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // 注文者：会社名
                    /発注者[:：\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // 発注者：会社名
                    /会社名[:：\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // 会社名：会社名
                    /御発注[:：\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // 御発注：会社名
                    /(株式会社[^\s\n\r]+)/i,                             // 株式会社XXX
                    /(有限会社[^\s\n\r]+)/i,                             // 有限会社XXX
                    /([^\s\n\r]*工業[^\s\n\r]*)/i,                       // XXX工業
                    /([^\s\n\r]*製作所[^\s\n\r]*)/i                      // XXX製作所
                ];
                
                for (const pattern of customerPatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.customer = match[1].trim();
                        console.log('発注者抽出:', data.customer);
                        break;
                    }
                }

                // 3. 品番抽出 - 英数字の組み合わせ（例：7-B7912-ｼ）
                const productCodePatterns = [
                    /品番[:：\s]*([A-Z0-9\-ｼ]+)/i,                       // 品番：7-B7912-2
                    /型番[:：\s]*([A-Z0-9\-ｼ]+)/i,                       // 型番：ABC-123
                    /Part\s*No\.?\s*[:：]?\s*([A-Z0-9\-ｼ]+)/i,          // Part No: 123-456
                    /製品番号[:：\s]*([A-Z0-9\-ｼ]+)/i,                   // 製品番号：PRD123
                    /品目\s*\(\s*([0-9]+\-[A-Z]+[0-9]+[\-ｼ]*[0-9]*)\s*\)/i, // 品目 (7-B7912-ｼ) 形式
                    /([0-9]+\-[A-Z]+[0-9]+[\-ｼ]*[0-9]*)/g,              // 7-B7912-2 または 7-B7912-ｼ 形式
                    /([A-Z]+[0-9]+\-[0-9]+\-[0-9]+)/g,                   // ABC123-45-6 形式
                    /([A-Z]+\-[0-9]+\-[A-Z0-9]+)/g,                      // ABC-123-XYZ 形式
                    /(P[0-9]+\-[0-9]+\-[0-9]+)/g,                        // P815-110-0162 形式
                    /(7\-B7\s*9\s*12[\-ｼ]*)/g,                          // スペース入りパターン 7-B7 9 12-ｼ
                    /([0-9]+[\-\s]*[A-Z]+[0-9]+[\-\s]*ｼ)/i,             // 7-B7912-ｼ のような特殊文字含む
                    /^[\s]*([0-9]+\-[A-Z]+[0-9]+[\-ｼ]+[0-9]*)[\s]*$/m   // 行独立の品番パターン
                ];
                
                for (let i = 0; i < productCodePatterns.length; i++) {
                    const pattern = productCodePatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.productCode = match[1].trim();
                        console.log(`品番抽出（パターン${i+1}）:`, data.productCode, 'マッチ:', match[0]);
                        break;
                    } else if (i < 5) { // 最初の5パターンのみデバッグ出力
                        console.log(`品番パターン${i+1}マッチなし:`, pattern);
                    }
                }

                // 4. 品名抽出 - 品番の近くにある日本語名称
                const productNamePatterns = [
                    /品名[:：\s]*([^\n\r]+)/i,                           // 品名：コネクタ VLN-15
                    /製品名[:：\s]*([^\n\r]+)/i,                         // 製品名：フランジ
                    /部品名[:：\s]*([^\n\r]+)/i,                         // 部品名：ボルト
                    /名称[:：\s]*([^\n\r]+)/i,                           // 名称：ガスケット
                    /品目[^(]*\([^)]*\)\s*\*?\s*([ｱ-ﾝｼﾘﾝﾀﾞ][^【\n\r]*)/i, // 品目 (7-B7912-ｼ) * ｼﾘﾝﾀﾞ(ﾍｲｶﾞﾜ)
                    /(ｼﾘﾝﾀﾞ[^【\n\r]*\([^)]*\))/i,                      // ｼﾘﾝﾀﾞ(ﾍｲｶﾞﾜ) 改良版
                    /(ｼﾘﾝﾀﾞ[^【\n\r]*)/i,                              // ｼﾘﾝﾀﾞXXX
                    /(コネクタ[^\n\r]*)/i,                               // コネクタ XXX
                    /(フランジ[^\n\r]*)/i,                               // フランジ XXX
                    /(ボルト[^\n\r]*)/i,                                 // ボルト XXX
                    /(ナット[^\n\r]*)/i,                                 // ナット XXX
                    /(ガスケット[^\n\r]*)/i,                             // ガスケット XXX
                    /(継手[^\n\r]*)/i,                                   // 継手 XXX
                    /(バルブ[^\n\r]*)/i,                                 // バルブ XXX
                    /(シリンダ[^\n\r]*)/i,                               // シリンダ XXX
                    /\*\s*([ｱ-ﾝ][ｱ-ﾝ\(\)]+)/i,                        // * ｼﾘﾝﾀﾞ(ﾍｲｶﾞﾜ) のような場合
                    /([ｱ-ﾝ]+\([ｱ-ﾝ]+\))/i                              // カタカナ名(カタカナ) パターン
                ];
                
                for (let i = 0; i < productNamePatterns.length; i++) {
                    const pattern = productNamePatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.productName = match[1].trim();
                        console.log(`品名抽出（パターン${i+1}）:`, data.productName, 'マッチ:', match[0]);
                        break;
                    } else if (i < 5) { // 最初の5パターンのみデバッグ出力
                        console.log(`品名パターン${i+1}マッチなし:`, pattern);
                    }
                }

                // 5. 材質抽出 - S13, S14, SCM435, SUS304, FCD400等
                const materials = [
                    'S13', 'S14', 'S15', 'SCM435', 'SCM440', 'SUS304', 'SUS316', 'SUS430',
                    'SCS13', 'SCS14', 'SCS16', 'SCS1', 'SCS2', 'SCS3', 'SCS5', 'SCS6',
                    'FC200', 'FC250', 'FC300', 'FC350', 'FC400', 'FCD400', 'FCD450', 'FCD500', 'FCD600', 'FCD700',
                    'SCPH1', 'SCPH2', 'SCPH11', 'SCPH12', 'SCPH13', 'SCPH21', 'SCPH32',
                    'SS400', 'SM490', 'A5052', 'A6061', 'A7075', 'C3604', 'C3771'
                ];
                
                // 材質パターンを優先順で検索（FCD、FC、SCPH拡張、スペース対応）
                const materialPatterns = [
                    /材質[:：\s]*(S13|S14|S15|SCM[0-9]+|SUS[0-9]+|SCS[0-9]+|FCD[0-9]+[\-0-9]*|FC[0-9]+|SCPH[0-9]+)/i,
                    /材料[:：\s]*(S13|S14|S15|SCM[0-9]+|SUS[0-9]+|SCS[0-9]+|FCD[0-9]+[\-0-9]*|FC[0-9]+|SCPH[0-9]+)/i,
                    /【\s*([FC]\s*[CD]*\s*[0-9]+\s*[\-0-9]*)\s*】/i,     // 【F   C   D400-15   】形式（スペース入り）
                    /【\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*】/i,              // 【FCD450-10】形式
                    /【\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*】/i,               // 【FC250】形式
                    /【\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*】/i,             // 【SCPH2】形式
                    /(FCD\s*[0-9]+\s*[\-0-9]*)/i,                        // FCD450-10 直接マッチ（スペース入り）
                    /(FC\s*[0-9]+\s*[\-0-9]*)/i,                         // FC250 直接マッチ（スペース入り）
                    /(SCPH\s*[0-9]+\s*[\-0-9]*)/i,                       // SCPH2 直接マッチ（スペース入り）
                    /\[\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*\]/i,              // [FCD450-10]形式
                    /\[\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*\]/i,               // [FC250]形式
                    /\[\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*\]/i,             // [SCPH2]形式
                    /^[\s]*【\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*】[\s]*$/m,  // 行独立の【FCD材質】パターン
                    /^[\s]*【\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*】[\s]*$/m,   // 行独立の【FC材質】パターン
                    /^[\s]*【\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*】[\s]*$/m, // 行独立の【SCPH材質】パターン
                    /\s+(FCD\s*[0-9]+\s*[\-0-9]*)\s+/i,                  // スペースに囲まれたFCD材質
                    /\s+(FC\s*[0-9]+\s*[\-0-9]*)\s+/i,                   // スペースに囲まれたFC材質
                    /\s+(SCPH\s*[0-9]+\s*[\-0-9]*)\s+/i,                 // スペースに囲まれたSCPH材質
                    /質\s*[\(（]\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*[\)）]/i, // 質(FCD450-10)パターン
                    /質\s*[\(（]\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*[\)）]/i,  // 質(FC250)パターン
                    /質\s*[\(（]\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*[\)）]/i, // 質(SCPH2)パターン
                    /^[\s]*(FCD\s*[0-9]+\s*[\-0-9]*)[\s]*$/m,            // 行独立のFCD材質
                    /^[\s]*(FC\s*[0-9]+\s*[\-0-9]*)[\s]*$/m,             // 行独立のFC材質
                    /^[\s]*(SCPH\s*[0-9]+\s*[\-0-9]*)[\s]*$/m            // 行独立のSCPH材質
                ];
                
                for (let i = 0; i < materialPatterns.length; i++) {
                    const pattern = materialPatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        // スペースを除去して正規化
                        data.material = match[1].replace(/\s+/g, '').toUpperCase();
                        console.log(`材質抽出（パターン${i+1}）:`, data.material, 'マッチ:', match[0]);
                        break;
                    } else if (i < 5) { // 最初の5パターンのみデバッグ出力
                        console.log(`材質パターン${i+1}マッチなし:`, pattern);
                    }
                }
                
                // パターンマッチで見つからない場合は単語検索
                if (!data.material) {
                    for (const material of materials) {
                        if (text.toUpperCase().includes(material)) {
                            data.material = material;
                            console.log('材質抽出（キーワード検索）:', data.material);
                            break;
                        }
                    }
                }

                // 6. 重量抽出 - "重量" "kg" の前の数値（オプション）
                const weightPatterns = [
                    /重量[:：\s]*([0-9]+\.?[0-9]*)\s*kg/i,                // 重量：13.2kg
                    /単重[:：\s]*([0-9]+\.?[0-9]*)\s*kg/i,                // 単重：13.2kg
                    /重さ[:：\s]*([0-9]+\.?[0-9]*)\s*kg/i,                // 重さ：13.2kg
                    /([0-9]+\.?[0-9]*)\s*kg/gi,                          // 13.2kg
                    /([0-9]+\.?[0-9]*)\s*㎏/gi,                          // 29.5㎏
                    /重量[:：\s]*([0-9]+\.?[0-9]*)/i,                     // 重量：13.2（単位なし）
                    /単重[:：\s]*([0-9]+\.?[0-9]*)/i,                     // 単重：13.2（単位なし）
                    /([0-9]+)\s*\.\s*([0-9]+)\s*㎏/i,                     // 2 9 .5㎏ (スペース入り)
                    /([0-9]+\s*[0-9]*)\s*\.\s*([0-9]+)\s*㎏/i,            // 29 .5㎏ のような分離パターン
                    /([0-9]{1,2})\s*\.\s*([0-9]+)\s*kg/gi,               // 29 .5kg の分離パターン
                    /重量\s*[:：]?\s*([0-9]+[\.\s]*[0-9]*)\s*[kgcg㎏]/i  // 重量分離パターン
                ];
                
                for (const pattern of weightPatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        // スペース区切りの重量パターンの場合
                        if (match[2]) {
                            data.unitWeight = parseFloat(match[1] + '.' + match[2]);
                        } else {
                            data.unitWeight = parseFloat(match[1]);
                        }
                        console.log('重量抽出:', data.unitWeight);
                        break;
                    }
                }

                // 7. 数量抽出 - "数量" "個" "ケ" の前の数値
                const quantityPatterns = [
                    /数量[:：\s]*([0-9]+)/i,                             // 数量：2
                    /個数[:：\s]*([0-9]+)/i,                             // 個数：2
                    /qty[:：\s]*([0-9]+)/i,                              // qty：2
                    /([0-9]+)\s*個/gi,                                   // 2個
                    /([0-9]+)\s*ケ/gi,                                   // 2ケ
                    /([0-9]+)\s*ヶ/gi,                                   // 2ヶ
                    /([0-9]+)\s*pc/gi,                                   // 2pc
                    /([0-9]+)\s*pcs/gi                                   // 2pcs
                ];
                
                for (const pattern of quantityPatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.quantity = parseInt(match[1]);
                        console.log('数量抽出:', data.quantity);
                        break;
                    }
                }

                // 8. 発注日抽出 - 発注日、注文日の日付形式（スペース対応）
                const orderDatePatterns = [
                    /発注日[:：\s]*([0-9]{4})[.\-\/年\s]*([0-9]{1,2})[.\-\/月\s]*([0-9]{1,2})/i,  // 発注日：2025.07.01
                    /注文日[:：\s]*([0-9]{4})[.\-\/年\s]*([0-9]{1,2})[.\-\/月\s]*([0-9]{1,2})/i,  // 注文日：2025.07.01
                    /受注日[:：\s]*([0-9]{4})[.\-\/年\s]*([0-9]{1,2})[.\-\/月\s]*([0-9]{1,2})/i,  // 受注日：2025.07.01
                    /日付[:：\s]*([0-9]{4})[.\-\/年\s]*([0-9]{1,2})[.\-\/月\s]*([0-9]{1,2})/i,    // 日付：2025.07.01
                    /作成日[:：\s]*([0-9]{4})[.\-\/年\s]*([0-9]{1,2})[.\-\/月\s]*([0-9]{1,2})/i,  // 作成日：2025.07.01
                    /発注日[:：\s]*([0-9]{4})[\.\s]*0?\s*([0-9]{1,2})[\.\s]*([0-9]{1,2})/i,      // 発注日：2025.0 7. 01 形式
                    /([0-9]{4})[\.\s]*0?\s*([0-9]{1,2})[\.\s]*([0-9]{1,2})/g                     // 2025.0 7. 01 形式（一般）
                ];
                
                for (let i = 0; i < orderDatePatterns.length; i++) {
                    const pattern = orderDatePatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1] && match[2] && match[3]) {
                        // スペースを除去して数値に変換
                        let year = match[1].replace(/\s+/g, '');
                        let month = match[2].replace(/\s+/g, '');
                        let day = match[3].replace(/\s+/g, '');
                        
                        // 数値検証とパディング
                        const yearNum = parseInt(year);
                        const monthNum = parseInt(month);
                        const dayNum = parseInt(day);
                        
                        if (yearNum >= 2020 && yearNum <= 2030 && monthNum >= 1 && monthNum <= 12 && dayNum >= 1 && dayNum <= 31) {
                            month = month.padStart(2, '0');
                            day = day.padStart(2, '0');
                            const dateStr = `${year}-${month}-${day}`;
                            
                            // 日付の妥当性チェック
                            const date = new Date(dateStr);
                            if (!isNaN(date.getTime()) && date.getFullYear() == yearNum && date.getMonth() == monthNum - 1 && date.getDate() == dayNum) {
                                data.orderDate = dateStr;
                                console.log(`発注日抽出（パターン${i+1}）:`, data.orderDate, 'マッチ:', match[0]);
                                break;
                            }
                        }
                    } else if (i < 3) { // 最初の3パターンのみデバッグ出力
                        console.log(`発注日パターン${i+1}マッチなし:`, pattern);
                    }
                }

                // 9. 納期抽出 - 日付形式（2025.06.05 → 2025/06/05）
                const deliveryDatePatterns = [
                    /納期[:：\s]*([0-9]{4})[.\-\/年]([0-9]{1,2})[.\-\/月]([0-9]{1,2})/i,  // 納期：2025.06.05
                    /納入[:：\s]*([0-9]{4})[.\-\/年]([0-9]{1,2})[.\-\/月]([0-9]{1,2})/i,  // 納入：2025.06.05
                    /納入日[:：\s]*([0-9]{4})[.\-\/年]([0-9]{1,2})[.\-\/月]([0-9]{1,2})/i, // 納入日：2025.06.05
                    /希望納期[:：\s]*([0-9]{4})[.\-\/年]([0-9]{1,2})[.\-\/月]([0-9]{1,2})/i, // 希望納期：2025.06.05
                    /納入希望日[:：\s]*([0-9]{4})[.\-\/年]([0-9]{1,2})[.\-\/月]([0-9]{1,2})/i, // 納入希望日：2025.06.05
                    /完成希望[:：\s]*([0-9]{4})[.\-\/年]([0-9]{1,2})[.\-\/月]([0-9]{1,2})/i  // 完成希望：2025.06.05
                ];
                
                for (const pattern of deliveryDatePatterns) {
                    const match = text.match(pattern);
                    if (match && match[1] && match[2] && match[3]) {
                        const year = match[1];
                        const month = match[2].padStart(2, '0');
                        const day = match[3].padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const date = new Date(dateStr);
                        
                        if (!isNaN(date.getTime()) && date.getFullYear() >= 2020 && date.getFullYear() <= 2030) {
                            data.deliveryDate = dateStr;
                            console.log('納期抽出:', data.deliveryDate);
                            break;
                        }
                    }
                }

                // フォールバック抽出（特定のパターンに特化）
                if (!data.orderNumber || !data.productCode || !data.productName || !data.material || !data.orderDate) {
                    console.log('=== フォールバック抽出開始 ===');
                    
                    // より積極的な検索
                    if (!data.orderNumber) {
                        // 数字のみのパターンを探す（8桁の数字）
                        const numberMatch = text.match(/\b([0-9]{8})\b/);
                        if (numberMatch) {
                            data.orderNumber = numberMatch[1];
                            console.log('フォールバック注文番号:', data.orderNumber);
                        }
                    }
                    
                    if (!data.productCode) {
                        // より緩い品番パターン
                        const codeMatch = text.match(/([0-9]+\-[A-Z]+[0-9]+(?:\-?ｼ)?)/);
                        if (codeMatch) {
                            data.productCode = codeMatch[1];
                            console.log('フォールバック品番:', data.productCode);
                        }
                    }
                    
                    if (!data.productName) {
                        // カタカナのみのパターン
                        const nameMatch = text.match(/(ｼﾘﾝﾀﾞ\([^)]+\))/);
                        if (nameMatch) {
                            data.productName = nameMatch[1];
                            console.log('フォールバック品名:', data.productName);
                        }
                    }
                    
                    if (!data.material) {
                        // スペース入りFCD、FC、SCPH系の材質を探す
                        const matMatch = text.match(/(F\s*C\s*D\s*[0-9]+\s*[\-0-9]*|F\s*C\s*[0-9]+\s*[\-0-9]*|S\s*C\s*P\s*H\s*[0-9]+\s*[\-0-9]*)/i);
                        if (matMatch) {
                            data.material = matMatch[1].replace(/\s+/g, '').toUpperCase();
                            console.log('フォールバック材質:', data.material);
                        }
                    }
                    
                    if (!data.orderDate) {
                        // より柔軟な発注日パターン（2025.0 7. 01 など）
                        const dateMatch = text.match(/(2025)[\.\s]*0?\s*([0-9]{1,2})[\.\s]*([0-9]{1,2})/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            let month = dateMatch[2].replace(/\s+/g, '');
                            let day = dateMatch[3].replace(/\s+/g, '');
                            
                            // 数値検証
                            const monthNum = parseInt(month);
                            const dayNum = parseInt(day);
                            
                            if (monthNum >= 1 && monthNum <= 12 && dayNum >= 1 && dayNum <= 31) {
                                month = month.padStart(2, '0');
                                day = day.padStart(2, '0');
                                const dateStr = `${year}-${month}-${day}`;
                                
                                // 日付の妥当性チェック
                                const date = new Date(dateStr);
                                if (!isNaN(date.getTime()) && date.getFullYear() == 2025 && date.getMonth() == monthNum - 1 && date.getDate() == dayNum) {
                                    data.orderDate = dateStr;
                                    console.log('フォールバック発注日:', data.orderDate);
                                }
                            }
                        }
                    }
                }

                console.log('=== PDF解析結果 ===');
                console.log('注文番号:', data.orderNumber);
                console.log('発注者:', data.customer);
                console.log('品番:', data.productCode);
                console.log('品名:', data.productName);
                console.log('材質:', data.material);
                console.log('重量:', data.unitWeight);
                console.log('数量:', data.quantity);
                console.log('発注日:', data.orderDate);   // 発注日を追加
                console.log('納期:', data.deliveryDate);

            } catch (error) {
                console.error('データ抽出エラー:', error);
            }

            return data;
        }

        // 複数ページ結果表示機能
        function displayMultiPageResults(pagesData) {
            const extractedDataContainer = document.getElementById('extractedDataContainer');
            if (!extractedDataContainer) return;

            // 複数ページのタブとコンテンツを生成
            let tabsHTML = '<ul class="nav nav-tabs" id="pdfPageTabs" role="tablist">';
            let contentHTML = '<div class="tab-content" id="pdfPageTabContent">';

            pagesData.forEach((pageData, index) => {
                const isActive = index === 0 ? 'active' : '';
                const pageNum = pageData.pageNumber;
                
                // タブヘッダー
                tabsHTML += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isActive}" id="page${pageNum}-tab" data-bs-toggle="tab" 
                                data-bs-target="#page${pageNum}" type="button" role="tab" 
                                aria-controls="page${pageNum}" aria-selected="${index === 0}">
                            ページ ${pageNum}
                            ${pageData.extractedData.orderNumber ? 
                                '<span class="badge bg-success ms-1">✓</span>' : 
                                '<span class="badge bg-warning ms-1">!</span>'}
                        </button>
                    </li>
                `;

                // タブコンテンツ
                contentHTML += `
                    <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="page${pageNum}" 
                         role="tabpanel" aria-labelledby="page${pageNum}-tab">
                        <div class="row mt-3">
                            <div class="col-md-8">
                                ${generatePageDataForm(pageData.extractedData, pageNum)}
                            </div>
                            <div class="col-md-4">
                                ${generatePageSummary(pageData.extractedData, pageNum)}
                            </div>
                        </div>
                    </div>
                `;
            });

            tabsHTML += '</ul>';
            contentHTML += '</div>';

            extractedDataContainer.innerHTML = `
                <div class="mb-3">
                    <h5>📄 PDF解析結果 (${pagesData.length}ページ)</h5>
                    <p class="text-muted">各ページのタブを選択して内容を確認してください。</p>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-success btn-sm" onclick="addAllOrdersFromPDF()">
                            📋 すべてのページを一括追加
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="validateAllPages()">
                            ✅ 全ページ検証
                        </button>
                    </div>
                </div>
                ${tabsHTML}
                ${contentHTML}
            `;

            // UI表示
            extractedDataContainer.classList.remove('d-none');
            const noDataMessage = document.getElementById('noDataMessage');
            if (noDataMessage) noDataMessage.classList.add('d-none');
        }

        // ページ別データフォーム生成
        function generatePageDataForm(data, pageNumber) {
            return `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ページ ${pageNumber} - 抽出データ</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>注文番号:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.orderNumber ? 'auto-filled' : ''}" 
                                       value="${data.orderNumber}" id="orderNumber_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>発注者:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.customer ? 'auto-filled' : ''}" 
                                       value="${data.customer}" id="customer_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>品番:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.productCode ? 'auto-filled' : ''}" 
                                       value="${data.productCode}" id="productCode_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>品名:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.productName ? 'auto-filled' : ''}" 
                                       value="${data.productName}" id="productName_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>材質:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.material ? 'auto-filled' : ''}" 
                                       value="${data.material}" id="material_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>単重量:</strong></div>
                            <div class="col-sm-9">
                                <input type="number" step="0.1" class="form-control form-control-sm ${data.unitWeight ? 'auto-filled' : ''}" 
                                       value="${data.unitWeight}" id="unitWeight_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>数量:</strong></div>
                            <div class="col-sm-9">
                                <input type="number" class="form-control form-control-sm ${data.quantity ? 'auto-filled' : ''}" 
                                       value="${data.quantity}" id="quantity_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>発注日:</strong></div>
                            <div class="col-sm-9">
                                <input type="date" class="form-control form-control-sm ${data.orderDate ? 'auto-filled' : ''}" 
                                       value="${data.orderDate}" id="orderDate_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>納期:</strong></div>
                            <div class="col-sm-9">
                                <input type="date" class="form-control form-control-sm ${data.deliveryDate ? 'auto-filled' : ''}" 
                                       value="${data.deliveryDate}" id="deliveryDate_${pageNumber}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-primary btn-sm me-2" 
                                        onclick="addOrderFromPage(${pageNumber})">
                                    📝 この注文をシステムに追加
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" 
                                        onclick="clearPageData(${pageNumber})">
                                    🗑️ クリア
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ページ概要表示
        function generatePageSummary(data, pageNumber) {
            // 重要フィールドのみをカウント（notesは除外）
            const importantFields = ['orderNumber', 'productCode', 'productName', 'material', 'unitWeight', 'quantity', 'orderDate', 'deliveryDate'];
            const filledFields = importantFields.filter(field => data[field] && data[field].toString().trim() !== '');
            const completeness = Math.round((filledFields.length / importantFields.length) * 100);

            return `
                <div class="card bg-light">
                    <div class="card-header">
                        <h6 class="mb-0">📊 ページ ${pageNumber} 概要</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>データ完成度</span>
                                <span>${completeness}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${completeness >= 70 ? 'bg-success' : completeness >= 40 ? 'bg-warning' : 'bg-danger'}" 
                                     style="width: ${completeness}%"></div>
                            </div>
                        </div>
                        <div class="small">
                            <div class="mb-1">
                                ${data.orderNumber && data.orderNumber.trim() ? '✅' : '❌'} 注文番号
                            </div>
                            <div class="mb-1">
                                ${data.productCode && data.productCode.trim() ? '✅' : '❌'} 品番
                            </div>
                            <div class="mb-1">
                                ${data.productName && data.productName.trim() ? '✅' : '❌'} 品名
                            </div>
                            <div class="mb-1">
                                ${data.material && data.material.trim() ? '✅' : '❌'} 材質
                            </div>
                            <div class="mb-1">
                                ${data.unitWeight && data.unitWeight.toString().trim() ? '✅' : '❌'} 単重量
                            </div>
                            <div class="mb-1">
                                ${data.quantity && data.quantity.toString().trim() ? '✅' : '❌'} 数量
                            </div>
                            <div class="mb-1">
                                ${data.orderDate && data.orderDate.trim() ? '✅' : '❌'} 発注日
                            </div>
                            <div class="mb-1">
                                ${data.deliveryDate && data.deliveryDate.trim() ? '✅' : '❌'} 納期
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ページデータから注文追加
        function addOrderFromPage(pageNumber) {
            try {
                console.log(`注文追加処理開始 - ページ ${pageNumber}`);
                
                const data = {
                    orderNumber: document.getElementById(`orderNumber_${pageNumber}`)?.value || '',
                    customer: document.getElementById(`customer_${pageNumber}`)?.value || '',
                    productCode: document.getElementById(`productCode_${pageNumber}`)?.value || '',
                    productName: document.getElementById(`productName_${pageNumber}`)?.value || '',
                    material: document.getElementById(`material_${pageNumber}`)?.value || '',
                    unitWeight: parseFloat(document.getElementById(`unitWeight_${pageNumber}`)?.value) || 0,
                    quantity: parseInt(document.getElementById(`quantity_${pageNumber}`)?.value) || 0,
                    orderDate: document.getElementById(`orderDate_${pageNumber}`)?.value || '',
                    deliveryDate: document.getElementById(`deliveryDate_${pageNumber}`)?.value || ''
                };
                
                console.log('抽出データ:', data);

            // データ検証
            if (!data.orderNumber || !data.productCode || !data.productName) {
                alert('注文番号、品番、品名は必須項目です。');
                return;
            }

            // 既存の注文番号との重複チェック
            const existingOrder = orders.find(order => order.orderNumber === data.orderNumber);
            if (existingOrder) {
                if (!confirm(`注文番号 "${data.orderNumber}" は既に存在します。上書きしますか？`)) {
                    return;
                }
                // 既存注文を削除
                const index = orders.findIndex(order => order.orderNumber === data.orderNumber);
                if (index !== -1) {
                    orders.splice(index, 1);
                }
            }

            // 総重量を計算
            const totalWeight = data.unitWeight * data.quantity;

            // 新しい注文オブジェクトを作成
            const newOrder = {
                id: 'PDF-' + Date.now(),
                orderNumber: data.orderNumber,
                customer: data.customer || '',
                productCode: data.productCode,
                productName: data.productName,
                material: data.material,
                unitWeight: data.unitWeight,
                quantity: data.quantity,
                totalWeight: totalWeight,
                orderDate: data.orderDate || '',
                deliveryDate: data.deliveryDate,
                status: 'pending',
                notes: 'PDF読み込みより追加'
            };

            // 注文をシステムに追加
            orders.push(newOrder);
            filteredOrders = [...orders];
            
            // データ保存
            saveData();
            
            // UI更新
            updateDashboard();
            updateTable();
            
            alert(`ページ ${pageNumber} の注文が正常に追加されました！\n注文番号: ${data.orderNumber}`);
            console.log('注文追加完了:', newOrder);
            
            // 成功通知を表示
            if (typeof showNotification === 'function') {
                showNotification(`注文 "${data.orderNumber}" を追加しました`, 'success');
            }
            
        } catch (error) {
            console.error('注文追加エラー:', error);
            alert(`注文追加中にエラーが発生しました: ${error.message}`);
        }
    }

        // 全ページ一括追加
        function addAllOrdersFromPDF() {
            const pdfPageTabs = document.querySelectorAll('#pdfPageTabs .nav-link');
            const pageNumbers = Array.from(pdfPageTabs).map(tab => {
                const match = tab.id.match(/page(\d+)-tab/);
                return match ? parseInt(match[1]) : null;
            }).filter(num => num !== null);

            if (pageNumbers.length === 0) {
                alert('追加するページが見つかりません。');
                return;
            }

            const confirmMessage = `${pageNumbers.length}ページすべての注文を一括追加しますか？\n\n追加されるページ: ${pageNumbers.join(', ')}`;
            if (!confirm(confirmMessage)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            pageNumbers.forEach(pageNumber => {
                try {
                    // 各ページのデータを取得
                    const data = {
                        orderNumber: document.getElementById(`orderNumber_${pageNumber}`)?.value || '',
                        productCode: document.getElementById(`productCode_${pageNumber}`)?.value || '',
                        productName: document.getElementById(`productName_${pageNumber}`)?.value || ''
                    };

                    // 必須項目チェック
                    if (!data.orderNumber || !data.productCode || !data.productName) {
                        errors.push(`ページ ${pageNumber}: 必須項目が不足しています`);
                        errorCount++;
                        return;
                    }

                    // 注文追加を実行（アラートなしバージョン）
                    addOrderFromPageSilent(pageNumber);
                    successCount++;
                } catch (error) {
                    errors.push(`ページ ${pageNumber}: ${error.message}`);
                    errorCount++;
                }
            });

            // 結果レポート
            let message = `一括追加完了！\n\n成功: ${successCount}件\nエラー: ${errorCount}件`;
            if (errors.length > 0) {
                message += '\n\nエラー詳細:\n' + errors.join('\n');
            }
            
            alert(message);
            
            // UI更新（一括処理後に実行）
            updateDashboard();
            updateTable();
            
            if (typeof showNotification === 'function') {
                showNotification(`${successCount}件の注文を一括追加しました`, 'success');
            }
        }

        // サイレント版注文追加（アラートなし）
        function addOrderFromPageSilent(pageNumber) {
            const data = {
                orderNumber: document.getElementById(`orderNumber_${pageNumber}`)?.value || '',
                customer: document.getElementById(`customer_${pageNumber}`)?.value || '',
                productCode: document.getElementById(`productCode_${pageNumber}`)?.value || '',
                productName: document.getElementById(`productName_${pageNumber}`)?.value || '',
                material: document.getElementById(`material_${pageNumber}`)?.value || '',
                unitWeight: parseFloat(document.getElementById(`unitWeight_${pageNumber}`)?.value) || 0,
                quantity: parseInt(document.getElementById(`quantity_${pageNumber}`)?.value) || 0,
                orderDate: document.getElementById(`orderDate_${pageNumber}`)?.value || '',
                deliveryDate: document.getElementById(`deliveryDate_${pageNumber}`)?.value || ''
            };

            // 既存の注文番号との重複チェック（サイレント）
            const existingOrder = orders.find(order => order.orderNumber === data.orderNumber);
            if (existingOrder) {
                const index = orders.findIndex(order => order.orderNumber === data.orderNumber);
                if (index !== -1) {
                    orders.splice(index, 1);
                }
            }

            // 総重量を計算
            const totalWeight = data.unitWeight * data.quantity;

            // 新しい注文オブジェクトを作成
            const newOrder = {
                id: 'PDF-' + Date.now() + '-' + pageNumber,
                orderNumber: data.orderNumber,
                customer: data.customer || '',
                productCode: data.productCode,
                productName: data.productName,
                material: data.material,
                unitWeight: data.unitWeight,
                quantity: data.quantity,
                totalWeight: totalWeight,
                orderDate: data.orderDate || '',
                deliveryDate: data.deliveryDate,
                status: 'pending',
                notes: `PDF読み込みより追加 (ページ ${pageNumber})`
            };

            // 注文をシステムに追加
            orders.push(newOrder);
            filteredOrders = [...orders];
            
            // データ保存
            saveData();
            
            // UI更新（最後に一回だけ実行するため、ここではコメントアウト）
            // updateDashboard();
            // updateTable();
        }

        // 全ページ検証
        function validateAllPages() {
            const pdfPageTabs = document.querySelectorAll('#pdfPageTabs .nav-link');
            const pageNumbers = Array.from(pdfPageTabs).map(tab => {
                const match = tab.id.match(/page(\d+)-tab/);
                return match ? parseInt(match[1]) : null;
            }).filter(num => num !== null);

            let report = '📋 全ページ検証レポート\n\n';
            let validPages = 0;
            let invalidPages = 0;

            pageNumbers.forEach(pageNumber => {
                const data = {
                    orderNumber: document.getElementById(`orderNumber_${pageNumber}`)?.value || '',
                    productCode: document.getElementById(`productCode_${pageNumber}`)?.value || '',
                    productName: document.getElementById(`productName_${pageNumber}`)?.value || '',
                    material: document.getElementById(`material_${pageNumber}`)?.value || '',
                    deliveryDate: document.getElementById(`deliveryDate_${pageNumber}`)?.value || ''
                };

                const missing = [];
                if (!data.orderNumber) missing.push('注文番号');
                if (!data.productCode) missing.push('品番');
                if (!data.productName) missing.push('品名');
                if (!data.material) missing.push('材質');
                if (!data.deliveryDate) missing.push('納期');

                if (missing.length === 0) {
                    report += `✅ ページ ${pageNumber}: 完全\n`;
                    validPages++;
                } else {
                    report += `❌ ページ ${pageNumber}: ${missing.join(', ')} が不足\n`;
                    invalidPages++;
                }
            });

            report += `\n📊 検証結果: 完全 ${validPages}件, 不完全 ${invalidPages}件`;
            alert(report);
        }

        // ページデータクリア
        function clearPageData(pageNumber) {
            if (confirm(`ページ ${pageNumber} の入力データをクリアしますか？`)) {
                const inputs = document.querySelectorAll(`#page${pageNumber} input`);
                inputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('auto-filled');
                });
            }
        }

        // 改善されたフォーム自動入力機能
        function populateExtractedData(data) {
            console.log('=== フォーム自動入力開始 ===');
            
            // 抽出データの品質評価
            const dataQuality = evaluateDataQuality(data);
            console.log('データ品質評価:', dataQuality);

            // フィールドマッピング定義（重量をオプションに変更）
            const fieldMappings = [
                { id: 'pdfOrderNumber', value: data.orderNumber, label: '注文番号', required: true },
                { id: 'pdfCustomer', value: data.customer, label: '発注者', required: false },
                { id: 'pdfProductCode', value: data.productCode, label: '品番', required: true },
                { id: 'pdfProductName', value: data.productName, label: '品名', required: true },
                { id: 'pdfMaterial', value: data.material, label: '材質', required: true },
                { id: 'pdfUnitWeight', value: data.unitWeight, label: '単重量', required: false }, // 重量をオプションに変更
                { id: 'pdfQuantity', value: data.quantity, label: '数量', required: true },
                { id: 'pdfDeliveryDate', value: data.deliveryDate, label: '納期', required: true },
                { id: 'pdfNotes', value: data.notes, label: '備考', required: false }
            ];

            // フォームフィールドに値を設定
            let filledCount = 0;
            let requiredFilledCount = 0;
            let totalRequiredCount = 0;

            fieldMappings.forEach(mapping => {
                const element = document.getElementById(mapping.id);
                if (element) {
                    // 既存値のクリア
                    element.value = '';
                    element.classList.remove('is-valid', 'is-invalid', 'auto-filled');

                    if (mapping.value !== null && mapping.value !== undefined && mapping.value !== '') {
                        // 値の設定
                        element.value = mapping.value;
                        filledCount++;
                        
                        // 視覚的フィードバック追加
                        element.classList.add('auto-filled');
                        
                        // バリデーション表示
                        if (validateFieldValue(mapping.id, mapping.value)) {
                            element.classList.add('is-valid');
                        } else {
                            element.classList.add('is-invalid');
                        }

                        if (mapping.required) {
                            requiredFilledCount++;
                        }

                        console.log(`✓ ${mapping.label}: "${mapping.value}"`);
                    } else {
                        console.log(`✗ ${mapping.label}: 未抽出`);
                        if (mapping.required) {
                            element.classList.add('is-invalid');
                        }
                    }

                    if (mapping.required) {
                        totalRequiredCount++;
                    }
                }
            });

            // 総重量の自動計算
            calculateTotalWeight();

            // 抽出結果サマリー表示
            showExtractionSummary(filledCount, requiredFilledCount, totalRequiredCount, dataQuality);

            // フォーム状態の更新
            updateFormState(requiredFilledCount, totalRequiredCount);

            // プレビュー機能の更新
            updateDataPreview(data, dataQuality);

            console.log(`=== フォーム自動入力完了 ===`);
            console.log(`入力項目: ${filledCount}/9`);
            console.log(`必須項目: ${requiredFilledCount}/${totalRequiredCount}`);
        }

        // データ品質評価関数
        function evaluateDataQuality(data) {
            const quality = {
                score: 0,
                maxScore: 8,
                details: {},
                level: '',
                color: ''
            };

            // 各項目の品質評価
            const evaluations = [
                { key: 'orderNumber', weight: 2, check: (val) => val && val.length >= 3 },
                { key: 'customer', weight: 1, check: (val) => val && val.length >= 2 },
                { key: 'productCode', weight: 2, check: (val) => val && /[A-Z0-9\-]/.test(val) },
                { key: 'productName', weight: 1, check: (val) => val && val.length >= 2 },
                { key: 'material', weight: 1, check: (val) => val && val.length >= 2 },
                { key: 'unitWeight', weight: 1, check: (val) => val && val > 0 },
                { key: 'quantity', weight: 1, check: (val) => val && val > 0 },
                { key: 'deliveryDate', weight: 1, check: (val) => val && new Date(val).getTime() > Date.now() }
            ];

            evaluations.forEach(eval => {
                const value = data[eval.key];
                const isValid = eval.check(value);
                quality.details[eval.key] = {
                    valid: isValid,
                    value: value,
                    weight: eval.weight
                };
                if (isValid) {
                    quality.score += eval.weight;
                }
            });

            // 品質レベル判定
            const percentage = (quality.score / quality.maxScore) * 100;
            if (percentage >= 80) {
                quality.level = '優秀';
                quality.color = 'success';
            } else if (percentage >= 60) {
                quality.level = '良好';
                quality.color = 'info';
            } else if (percentage >= 40) {
                quality.level = '普通';
                quality.color = 'warning';
            } else {
                quality.level = '要確認';
                quality.color = 'danger';
            }

            return quality;
        }

        // フィールド値のバリデーション
        function validateFieldValue(fieldId, value) {
            switch (fieldId) {
                case 'pdfOrderNumber':
                    return value && value.toString().length >= 3;
                case 'pdfProductCode':
                    return value && /[A-Z0-9\-]/.test(value);
                case 'pdfProductName':
                    return value && value.toString().length >= 2;
                case 'pdfMaterial':
                    return value && value.toString().length >= 2;
                case 'pdfUnitWeight':
                    return value && !isNaN(value) && parseFloat(value) > 0;
                case 'pdfQuantity':
                    return value && !isNaN(value) && parseInt(value) > 0;
                case 'pdfDeliveryDate':
                    return value && new Date(value).getTime() > Date.now() - (24 * 60 * 60 * 1000);
                default:
                    return true;
            }
        }

        // 総重量の自動計算
        function calculateTotalWeight() {
            const unitWeight = parseFloat(document.getElementById('pdfUnitWeight')?.value) || 0;
            const quantity = parseInt(document.getElementById('pdfQuantity')?.value) || 0;
            const totalWeight = unitWeight * quantity;

            // 総重量表示エリアの更新（存在する場合）
            const totalWeightDisplay = document.getElementById('pdfTotalWeight');
            if (totalWeightDisplay) {
                totalWeightDisplay.textContent = totalWeight.toFixed(1) + 'kg';
            }

            return totalWeight;
        }

        // 抽出結果サマリー表示
        function showExtractionSummary(filledCount, requiredFilledCount, totalRequiredCount, dataQuality) {
            // サマリー表示エリアの作成/更新
            let summaryElement = document.getElementById('extractionSummary');
            if (!summaryElement) {
                summaryElement = document.createElement('div');
                summaryElement.id = 'extractionSummary';
                summaryElement.className = 'alert mt-3';
                
                // 抽出テキストエリアの前に挿入
                const extractedTextCard = document.querySelector('#extractedText').closest('.card');
                extractedTextCard.parentNode.insertBefore(summaryElement, extractedTextCard);
            }

            const percentage = Math.round((dataQuality.score / dataQuality.maxScore) * 100);
            
            summaryElement.className = `alert alert-${dataQuality.color} mt-3`;
            summaryElement.innerHTML = `
                <h6><i class="bi bi-clipboard-data"></i> 抽出結果サマリー</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>入力項目:</strong> ${filledCount}/9 項目</p>
                        <p class="mb-1"><strong>必須項目:</strong> ${requiredFilledCount}/${totalRequiredCount} 項目</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>データ品質:</strong> 
                            <span class="badge bg-${dataQuality.color}">${dataQuality.level}</span> 
                            (${percentage}%)
                        </p>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-${dataQuality.color}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                </div>
                ${requiredFilledCount < totalRequiredCount ? 
                    '<small class="text-muted"><i class="bi bi-exclamation-triangle"></i> 未入力の必須項目があります。手動で入力してください。</small>' : 
                    '<small class="text-success"><i class="bi bi-check-circle"></i> すべての必須項目が入力されています。</small>'
                }
            `;
        }

        // フォーム状態の更新
        function updateFormState(requiredFilledCount, totalRequiredCount) {
            const addButton = document.getElementById('addFromPDFBtn');
            if (addButton) {
                const canSubmit = requiredFilledCount === totalRequiredCount;
                addButton.disabled = !canSubmit;
                
                if (canSubmit) {
                    addButton.innerHTML = '<i class="bi bi-plus-circle"></i> 注文として追加';
                    addButton.className = 'btn btn-success';
                } else {
                    addButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i> 必須項目を入力してください';
                    addButton.className = 'btn btn-warning';
                }
            }
        }

        // データプレビュー更新
        function updateDataPreview(data, dataQuality) {
            // プレビューエリアの作成/更新
            let previewElement = document.getElementById('dataPreview');
            if (!previewElement) {
                previewElement = document.createElement('div');
                previewElement.id = 'dataPreview';
                previewElement.className = 'mt-3';
                
                // 抽出データフォームの後に挿入
                const formContainer = document.getElementById('extractedDataContainer');
                formContainer.appendChild(previewElement);
            }

            const totalWeight = calculateTotalWeight();
            const isComplete = Object.values(data).filter(v => v !== null && v !== undefined && v !== '').length >= 6;

            previewElement.innerHTML = `
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-eye"></i> データプレビュー</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th>注文番号:</th><td>${data.orderNumber || '未入力'}</td></tr>
                                    <tr><th>発注者:</th><td>${data.customer || '未入力'}</td></tr>
                                    <tr><th>品番:</th><td>${data.productCode || '未入力'}</td></tr>
                                    <tr><th>品名:</th><td>${data.productName || '未入力'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th>材質:</th><td>${data.material || '未入力'}</td></tr>
                                    <tr><th>単重量:</th><td>${data.unitWeight ? data.unitWeight + 'kg' : '未入力'}</td></tr>
                                    <tr><th>数量:</th><td>${data.quantity || '未入力'}</td></tr>
                                    <tr><th>総重量:</th><td class="fw-bold text-primary">${totalWeight > 0 ? totalWeight.toFixed(1) + 'kg' : '未計算'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <table class="table table-sm">
                                    <tr><th>納期:</th><td>${data.deliveryDate || '未入力'}</td></tr>
                                    <tr><th>備考:</th><td>${data.notes || '(なし)'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="text-center">
                            ${isComplete ? 
                                '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 登録準備完了</span>' : 
                                '<span class="badge bg-warning"><i class="bi bi-pencil"></i> 手動入力が必要</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // フォームフィールドの変更監視（リアルタイム更新）
        function setupFormWatchers() {
            const watchFields = ['pdfOrderNumber', 'pdfCustomer', 'pdfProductCode', 'pdfProductName', 
                               'pdfMaterial', 'pdfUnitWeight', 'pdfQuantity', 'pdfDeliveryDate', 'pdfNotes'];
            
            watchFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', function() {
                        // リアルタイムバリデーション
                        const isValid = validateFieldValue(fieldId, this.value);
                        this.classList.remove('is-valid', 'is-invalid');
                        if (this.value) {
                            this.classList.add(isValid ? 'is-valid' : 'is-invalid');
                        }

                        // 重量計算の更新
                        if (fieldId === 'pdfUnitWeight' || fieldId === 'pdfQuantity') {
                            calculateTotalWeight();
                        }

                        // フォーム状態の更新
                        updateFormStatusRealtime();
                    });
                }
            });
        }

        // リアルタイムフォーム状態更新
        function updateFormStatusRealtime() {
            const requiredFields = ['pdfOrderNumber', 'pdfProductCode', 'pdfProductName', 
                                  'pdfMaterial', 'pdfUnitWeight', 'pdfQuantity', 'pdfDeliveryDate'];
            
            let requiredFilledCount = 0;
            requiredFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && element.value && validateFieldValue(fieldId, element.value)) {
                    requiredFilledCount++;
                }
            });

            updateFormState(requiredFilledCount, requiredFields.length);
        }

        // 全ページ一括追加機能（右下ボタン用）
        async function addOrderFromPDF() {
            // 確認ダイアログ
            const confirmation = confirm('PDFから抽出されたすべてのページの注文を一括でシステムに追加しますか？\n\n※データが不完全なページはスキップされます。');
            if (!confirmation) return;

            // 進捗表示の準備
            showBulkAddProgress();

            try {
                // すべてのページタブを取得
                const pdfPageTabs = document.querySelectorAll('#pdfPageTabs .nav-link');
                const pageNumbers = Array.from(pdfPageTabs).map(tab => {
                    const match = tab.id.match(/page(\d+)-tab/);
                    return match ? parseInt(match[1]) : null;
                }).filter(num => num !== null);

                if (pageNumbers.length === 0) {
                    alert('追加するページが見つかりません。PDFを読み込んでから実行してください。');
                    hideBulkAddProgress();
                    return;
                }

                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                const addedOrders = [];

                updateBulkAddProgress(0, pageNumbers.length, 'ページデータを確認中...');

                // 各ページを順次処理
                for (let i = 0; i < pageNumbers.length; i++) {
                    const pageNumber = pageNumbers[i];
                    
                    try {
                        updateBulkAddProgress(i + 1, pageNumbers.length, `ページ ${pageNumber} を処理中...`);
                        
                        // ページデータを取得
                        const data = {
                            orderNumber: document.getElementById(`orderNumber_${pageNumber}`)?.value?.trim() || '',
                            customer: document.getElementById(`customer_${pageNumber}`)?.value?.trim() || '',
                            productCode: document.getElementById(`productCode_${pageNumber}`)?.value?.trim() || '',
                            productName: document.getElementById(`productName_${pageNumber}`)?.value?.trim() || '',
                            material: document.getElementById(`material_${pageNumber}`)?.value?.trim() || '',
                            unitWeight: parseFloat(document.getElementById(`unitWeight_${pageNumber}`)?.value) || 0,
                            quantity: parseInt(document.getElementById(`quantity_${pageNumber}`)?.value) || 0,
                            orderDate: document.getElementById(`orderDate_${pageNumber}`)?.value?.trim() || '',
                            deliveryDate: document.getElementById(`deliveryDate_${pageNumber}`)?.value?.trim() || ''
                        };

                        // 必須項目チェック
                        if (!data.orderNumber || !data.productCode || !data.productName) {
                            errors.push(`ページ ${pageNumber}: 必須項目（注文番号、品番、品名）が不足`);
                            errorCount++;
                            continue;
                        }

                        // 重複チェック
                        const existingOrder = orders.find(order => order.orderNumber === data.orderNumber);
                        if (existingOrder) {
                            // 重複の場合は既存を削除して新しいデータで上書き
                            const index = orders.findIndex(order => order.orderNumber === data.orderNumber);
                            if (index !== -1) {
                                orders.splice(index, 1);
                            }
                        }

                        // 総重量を計算
                        const totalWeight = data.unitWeight * data.quantity;

                        // 新しい注文オブジェクトを作成
                        const newOrder = {
                            id: 'PDF-' + Date.now() + '-' + pageNumber,
                            orderNumber: data.orderNumber,
                            customer: data.customer || '',
                            productCode: data.productCode,
                            productName: data.productName,
                            material: data.material,
                            unitWeight: data.unitWeight,
                            quantity: data.quantity,
                            totalWeight: totalWeight,
                            orderDate: data.orderDate || '',
                            deliveryDate: data.deliveryDate,
                            status: 'pending',
                            notes: `PDF一括読み込み (ページ ${pageNumber})`
                        };

                        // 注文をシステムに追加
                        orders.push(newOrder);
                        addedOrders.push(newOrder);
                        successCount++;

                        // 少し待機（UIの応答性向上）
                        await new Promise(resolve => setTimeout(resolve, 100));

                    } catch (error) {
                        errorCount++;
                        errors.push(`ページ ${pageNumber}: ${error.message}`);
                        console.error(`ページ${pageNumber}でエラー:`, error);
                    }
                }

                // 処理完了後の更新
                filteredOrders = [...orders];
                saveData();
                updateDashboard();
                updateTable();

                // 進捗表示を隠す
                hideBulkAddProgress();

                // 結果レポート表示
                showBulkAddResults({
                    total: pageNumbers.length,
                    success: successCount,
                    error: errorCount,
                    errors: errors,
                    addedOrders: addedOrders
                });

                // モーダルを閉じる
                if (successCount > 0) {
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
                        if (modal) modal.hide();
                    }, 2000);
                }

            } catch (error) {
                hideBulkAddProgress();
                console.error('一括追加処理エラー:', error);
                alert(`一括追加中にエラーが発生しました: ${error.message}`);
            }
        }

        // 進捗表示機能
        function showBulkAddProgress() {
            // 既存の進捗ダイアログがあれば削除
            const existingProgress = document.getElementById('bulkAddProgress');
            if (existingProgress) existingProgress.remove();

            // 進捗ダイアログを作成
            const progressHtml = `
                <div id="bulkAddProgress" class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-cloud-upload"></i> 一括追加処理中
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div class="progress mb-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" id="bulkAddProgressBar" style="width: 0%"></div>
                                </div>
                                <div id="bulkAddStatus">処理を開始しています...</div>
                                <div class="text-muted small mt-2" id="bulkAddDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', progressHtml);
        }

        function updateBulkAddProgress(current, total, message) {
            const progressBar = document.getElementById('bulkAddProgressBar');
            const status = document.getElementById('bulkAddStatus');
            const details = document.getElementById('bulkAddDetails');
            
            if (progressBar) {
                const percentage = Math.round((current / total) * 100);
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
            }
            
            if (status) status.textContent = message;
            if (details) details.textContent = `${current} / ${total} ページ処理済み`;
        }

        function hideBulkAddProgress() {
            const progressDialog = document.getElementById('bulkAddProgress');
            if (progressDialog) progressDialog.remove();
        }

        // 結果表示機能
        function showBulkAddResults(results) {
            const { total, success, error, errors, addedOrders } = results;
            
            let message = `📊 一括追加処理が完了しました！\n\n`;
            message += `✅ 成功: ${success}件\n`;
            message += `❌ エラー: ${error}件\n`;
            message += `📝 処理対象: ${total}ページ\n\n`;
            
            if (success > 0) {
                message += `✨ 追加された注文:\n`;
                addedOrders.slice(0, 5).forEach(order => {
                    message += `• ${order.orderNumber} - ${order.productName}\n`;
                });
                if (addedOrders.length > 5) {
                    message += `• ...他 ${addedOrders.length - 5}件\n`;
                }
                message += '\n';
            }
            
            if (errors.length > 0) {
                message += `⚠️ エラー詳細:\n`;
                errors.slice(0, 3).forEach(error => {
                    message += `• ${error}\n`;
                });
                if (errors.length > 3) {
                    message += `• ...他 ${errors.length - 3}件\n`;
                }
            }

            alert(message);
            
            // 成功通知
            if (success > 0 && typeof showNotification === 'function') {
                showNotification(`${success}件の注文を一括追加しました`, 'success');
            }
        }

        // === 不足していた関数の追加 ===
        
        // 新規注文追加モーダル表示
        function showAddOrderModal() {
            const today = new Date();
            today.setDate(today.getDate() + 30);
            document.getElementById('newDeliveryDate').value = today.toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('addOrderModal')).show();
        }

        // 新規注文保存
        function saveNewOrder() {
            const form = document.getElementById('addOrderForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const unitWeight = parseFloat(document.getElementById('newUnitWeight').value);
            const quantity = parseInt(document.getElementById('newQuantity').value);

            const newOrder = {
                id: 'ORD-' + Date.now(),
                orderNumber: document.getElementById('newOrderNumber').value,
                customer: document.getElementById('newCustomer').value || '',
                productCode: document.getElementById('newProductCode').value,
                productName: document.getElementById('newProductName').value,
                material: document.getElementById('newMaterial').value,
                unitWeight: unitWeight,
                quantity: quantity,
                totalWeight: unitWeight * quantity,
                orderDate: document.getElementById('newOrderDate').value || '',
                deliveryDate: document.getElementById('newDeliveryDate').value,
                status: 'pending',
                notes: document.getElementById('newNotes').value
            };

            orders.push(newOrder);
            filteredOrders = [...orders];
            saveData();
            updateDashboard();
            updateTable();

            bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
            form.reset();
            showNotification('新規注文を追加しました', 'success');
        }

        // Excel取込モーダル表示
        function showExcelModal() {
            resetExcelModal();
            const modal = new bootstrap.Modal(document.getElementById('excelModal'));
            modal.show();
        }

        // Excelモーダルリセット
        function resetExcelModal() {
            const excelFileInput = document.getElementById('excelFileInput');
            const excelProcessingStatus = document.getElementById('excelProcessingStatus');
            const excelPreview = document.getElementById('excelPreview');
            const excelExtractedDataContainer = document.getElementById('excelExtractedDataContainer');
            const excelNoDataMessage = document.getElementById('excelNoDataMessage');
            const addFromExcelBtn = document.getElementById('addFromExcelBtn');

            if (excelFileInput) excelFileInput.value = '';
            if (excelProcessingStatus) excelProcessingStatus.classList.add('d-none');
            if (excelPreview) excelPreview.classList.add('d-none');
            if (excelExtractedDataContainer) excelExtractedDataContainer.classList.add('d-none');
            if (excelNoDataMessage) excelNoDataMessage.classList.remove('d-none');
            if (addFromExcelBtn) {
                addFromExcelBtn.disabled = true;
                addFromExcelBtn.innerHTML = '<i class="bi bi-plus-circle"></i> データを追加';
                addFromExcelBtn.title = 'Excelファイルを読み込んでから使用してください';
            }
        }

        // Excelファイル選択処理
        async function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                'application/vnd.ms-excel', // .xls
                'text/csv' // .csv
            ];

            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                alert('Excel（.xlsx, .xls）またはCSV（.csv）ファイルを選択してください。');
                return;
            }

            try {
                // 処理中表示
                const excelProcessingStatus = document.getElementById('excelProcessingStatus');
                const excelNoDataMessage = document.getElementById('excelNoDataMessage');
                
                if (excelProcessingStatus) excelProcessingStatus.classList.remove('d-none');
                if (excelNoDataMessage) excelNoDataMessage.classList.add('d-none');

                // SheetJSライブラリを使用してExcelファイルを読み込み
                if (typeof XLSX === 'undefined') {
                    throw new Error('Excel処理ライブラリが読み込まれていません');
                }

                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // 最初のシートを取得
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // シートをJSONに変換
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                console.log('Excel読み込み完了:', jsonData);
                
                // データ解析と表示
                const extractedOrders = parseExcelData(jsonData);
                displayExcelResults(extractedOrders, firstSheetName);

                // UI更新
                if (excelProcessingStatus) excelProcessingStatus.classList.add('d-none');
                const excelPreview = document.getElementById('excelPreview');
                const excelExtractedDataContainer = document.getElementById('excelExtractedDataContainer');
                
                if (excelPreview) excelPreview.classList.remove('d-none');
                if (excelExtractedDataContainer) excelExtractedDataContainer.classList.remove('d-none');
                if (excelNoDataMessage) excelNoDataMessage.classList.add('d-none');

                // 一括追加ボタンを有効化
                const addFromExcelBtn = document.getElementById('addFromExcelBtn');
                if (addFromExcelBtn) {
                    addFromExcelBtn.disabled = false;
                    addFromExcelBtn.innerHTML = '<i class="bi bi-upload"></i> 全データ一括追加';
                    addFromExcelBtn.title = `${extractedOrders.length}行のデータを一括でシステムに追加します`;
                }

            } catch (error) {
                console.error('Excel処理エラー:', error);
                alert('Excelファイルの処理中にエラーが発生しました：' + error.message);
                const excelProcessingStatus = document.getElementById('excelProcessingStatus');
                if (excelProcessingStatus) excelProcessingStatus.classList.add('d-none');
            }
        }

        // Excelデータ解析
        function parseExcelData(jsonData) {
            if (!jsonData || jsonData.length < 2) {
                return [];
            }

            const extractedOrders = [];
            const headers = jsonData[0]; // 1行目をヘッダーとして使用
            
            // ヘッダーから列のインデックスを特定
            const columnMap = {};
            headers.forEach((header, index) => {
                const headerStr = String(header).toLowerCase();
                if (headerStr.includes('注文') || headerStr.includes('order')) {
                    columnMap.orderNumber = index;
                } else if (headerStr.includes('発注者') || headerStr.includes('customer') || headerStr.includes('顧客')) {
                    columnMap.customer = index;
                } else if (headerStr.includes('品番') || headerStr.includes('product') && headerStr.includes('code')) {
                    columnMap.productCode = index;
                } else if (headerStr.includes('品名') || headerStr.includes('product') && headerStr.includes('name')) {
                    columnMap.productName = index;
                } else if (headerStr.includes('材質') || headerStr.includes('material')) {
                    columnMap.material = index;
                } else if (headerStr.includes('単重量') || headerStr.includes('unit') && headerStr.includes('weight')) {
                    columnMap.unitWeight = index;
                } else if (headerStr.includes('数量') || headerStr.includes('quantity')) {
                    columnMap.quantity = index;
                } else if (headerStr.includes('発注日') || headerStr.includes('order') && headerStr.includes('date')) {
                    columnMap.orderDate = index;
                } else if (headerStr.includes('納期') || headerStr.includes('delivery')) {
                    columnMap.deliveryDate = index;
                } else if (headerStr.includes('備考') || headerStr.includes('notes')) {
                    columnMap.notes = index;
                }
            });

            // データ行を処理（2行目以降）
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const orderData = {
                    rowNumber: i + 1,
                    orderNumber: columnMap.orderNumber !== undefined ? String(row[columnMap.orderNumber] || '') : '',
                    customer: columnMap.customer !== undefined ? String(row[columnMap.customer] || '') : '',
                    productCode: columnMap.productCode !== undefined ? String(row[columnMap.productCode] || '') : '',
                    productName: columnMap.productName !== undefined ? String(row[columnMap.productName] || '') : '',
                    material: columnMap.material !== undefined ? String(row[columnMap.material] || '') : '',
                    unitWeight: columnMap.unitWeight !== undefined ? parseFloat(row[columnMap.unitWeight]) || 0 : 0,
                    quantity: columnMap.quantity !== undefined ? parseInt(row[columnMap.quantity]) || 0 : 0,
                    orderDate: columnMap.orderDate !== undefined ? formatExcelDate(row[columnMap.orderDate]) : '',
                    deliveryDate: columnMap.deliveryDate !== undefined ? formatExcelDate(row[columnMap.deliveryDate]) : '',
                    notes: columnMap.notes !== undefined ? String(row[columnMap.notes] || '') : ''
                };

                // 最低限のデータがある行のみ追加
                if (orderData.orderNumber || orderData.productCode || orderData.productName) {
                    orderData.totalWeight = orderData.unitWeight * orderData.quantity;
                    extractedOrders.push(orderData);
                }
            }

            return extractedOrders;
        }

        // Excel日付フォーマット変換
        function formatExcelDate(excelDate) {
            if (!excelDate) return '';
            
            // 既に文字列の場合
            if (typeof excelDate === 'string') {
                return excelDate;
            }
            
            // Excelのシリアル値の場合
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            }
            
            return String(excelDate);
        }

        // Excel結果表示
        function displayExcelResults(extractedOrders, sheetName) {
            const excelExtractedDataContainer = document.getElementById('excelExtractedDataContainer');
            if (!excelExtractedDataContainer) return;

            if (extractedOrders.length === 0) {
                excelExtractedDataContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <h6>データが見つかりませんでした</h6>
                        <p>シート「${sheetName}」から有効なデータを抽出できませんでした。</p>
                        <small>ヘッダー行に「注文番号」「品番」「品名」などの列があることを確認してください。</small>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="mb-3">
                    <h5>📊 Excel解析結果</h5>
                    <p class="text-muted">シート「${sheetName}」から ${extractedOrders.length} 件のデータを抽出しました。</p>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-success btn-sm" onclick="addAllOrdersFromExcel()">
                            📋 全データを一括追加
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="validateExcelData()">
                            ✅ データ検証
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>行</th>
                                <th>注文番号</th>
                                <th>発注者</th>
                                <th>品番</th>
                                <th>品名</th>
                                <th>材質</th>
                                <th>単重量</th>
                                <th>数量</th>
                                <th>総重量</th>
                                <th>発注日</th>
                                <th>納期</th>
                                <th>備考</th>
                                <th>状態</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            extractedOrders.forEach((order, index) => {
                const isValid = order.orderNumber && order.productCode && order.productName;
                const rowClass = isValid ? '' : 'table-warning';
                const statusIcon = isValid ? '✅' : '⚠️';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${order.rowNumber}</td>
                        <td>${order.orderNumber}</td>
                        <td>${order.customer}</td>
                        <td>${order.productCode}</td>
                        <td>${order.productName}</td>
                        <td>${order.material}</td>
                        <td>${order.unitWeight}kg</td>
                        <td>${order.quantity}</td>
                        <td><strong>${order.totalWeight.toFixed(1)}kg</strong></td>
                        <td>${order.orderDate}</td>
                        <td>${order.deliveryDate}</td>
                        <td>${order.notes}</td>
                        <td>${statusIcon}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            excelExtractedDataContainer.innerHTML = tableHTML;
            excelExtractedDataContainer.classList.remove('d-none');
        }

        // Excel全データ一括追加
        async function addAllOrdersFromExcel() {
            const confirmation = confirm('Excelから抽出されたすべてのデータを一括でシステムに追加しますか？\n\n※データが不完全な行はスキップされます。');
            if (!confirmation) return;

            try {
                // データを取得（グローバル変数または再解析）
                const tableRows = document.querySelectorAll('#excelExtractedDataContainer tbody tr');
                const extractedOrders = [];

                tableRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 12) {
                        const orderData = {
                            orderNumber: cells[1].textContent.trim(),
                            customer: cells[2].textContent.trim(),
                            productCode: cells[3].textContent.trim(),
                            productName: cells[4].textContent.trim(),
                            material: cells[5].textContent.trim(),
                            unitWeight: parseFloat(cells[6].textContent.replace('kg', '')) || 0,
                            quantity: parseInt(cells[7].textContent) || 0,
                            orderDate: cells[9].textContent.trim(),
                            deliveryDate: cells[10].textContent.trim(),
                            notes: cells[11].textContent.trim()
                        };

                        if (orderData.orderNumber && orderData.productCode && orderData.productName) {
                            extractedOrders.push(orderData);
                        }
                    }
                });

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                extractedOrders.forEach((orderData, index) => {
                    try {
                        // 重複チェック
                        const existingOrder = orders.find(order => order.orderNumber === orderData.orderNumber);
                        if (existingOrder) {
                            const orderIndex = orders.findIndex(order => order.orderNumber === orderData.orderNumber);
                            if (orderIndex !== -1) {
                                orders.splice(orderIndex, 1);
                            }
                        }

                        // 新しい注文オブジェクトを作成
                        const newOrder = {
                            id: 'EXCEL-' + Date.now() + '-' + index,
                            orderNumber: orderData.orderNumber,
                            customer: orderData.customer || '',
                            productCode: orderData.productCode,
                            productName: orderData.productName,
                            material: orderData.material,
                            unitWeight: orderData.unitWeight,
                            quantity: orderData.quantity,
                            totalWeight: orderData.unitWeight * orderData.quantity,
                            orderDate: orderData.orderDate || '',
                            deliveryDate: orderData.deliveryDate,
                            status: 'pending',
                            notes: orderData.notes ? orderData.notes + ' [Excel取込]' : '[Excel取込]'
                        };

                        orders.push(newOrder);
                        successCount++;

                    } catch (error) {
                        errorCount++;
                        errors.push(`行 ${index + 1}: ${error.message}`);
                        console.error(`Excel行${index + 1}でエラー:`, error);
                    }
                });

                // システム更新
                filteredOrders = [...orders];
                saveData();
                updateDashboard();
                updateTable();

                // 結果表示
                let message = `📊 Excel一括追加が完了しました！\n\n`;
                message += `✅ 成功: ${successCount}件\n`;
                message += `❌ エラー: ${errorCount}件\n`;
                
                if (errors.length > 0) {
                    message += `\n⚠️ エラー詳細:\n`;
                    errors.slice(0, 3).forEach(error => {
                        message += `• ${error}\n`;
                    });
                    if (errors.length > 3) {
                        message += `• ...他 ${errors.length - 3}件\n`;
                    }
                }

                alert(message);
                showNotification(`${successCount}件の注文をExcelから一括追加しました`, 'success');

                // モーダルを閉じる
                if (successCount > 0) {
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('excelModal'));
                        if (modal) modal.hide();
                    }, 2000);
                }

            } catch (error) {
                console.error('Excel一括追加エラー:', error);
                alert(`Excel一括追加中にエラーが発生しました: ${error.message}`);
            }
        }

        // Excelデータ検証
        function validateExcelData() {
            const tableRows = document.querySelectorAll('#excelExtractedDataContainer tbody tr');
            let validCount = 0;
            let invalidCount = 0;
            let report = '📋 Excelデータ検証レポート\n\n';

            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 12) {
                    const rowNumber = cells[0].textContent;
                    const orderNumber = cells[1].textContent.trim();
                    const productCode = cells[3].textContent.trim();
                    const productName = cells[4].textContent.trim();
                    
                    if (orderNumber && productCode && productName) {
                        validCount++;
                    } else {
                        invalidCount++;
                        const missing = [];
                        if (!orderNumber) missing.push('注文番号');
                        if (!productCode) missing.push('品番');
                        if (!productName) missing.push('品名');
                        report += `❌ 行 ${rowNumber}: ${missing.join(', ')} が不足\n`;
                    }
                }
            });

            report += `\n📊 検証結果: 有効 ${validCount}件, 無効 ${invalidCount}件`;
            alert(report);
        }

        // CSVエクスポート機能
        function exportToCSV() {
            if (orders.length === 0) {
                alert('エクスポートするデータがありません。');
                return;
            }

            const headers = [
                '注文番号', '発注者', '品番', '品名', '材質', 
                '単重量(kg)', '数量', '総重量(kg)', '発注日', '納期', '状態', '備考'
            ];

            const csvData = orders.map(order => [
                order.orderNumber || '',
                order.customer || '',
                order.productCode || '',
                order.productName || '',
                order.material || '',
                order.unitWeight || 0,
                order.quantity || 0,
                order.totalWeight || 0,
                order.orderDate || '',
                order.deliveryDate || '',
                order.status || '',
                order.notes || ''
            ]);

            const csvContent = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `注文管理_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`${orders.length}件の注文をCSVでエクスポートしました`, 'success');
        }

        // バッチ最適化機能
        function runBatchOptimization() {
            if (orders.length === 0) {
                alert('最適化するデータがありません。');
                return;
            }

            const materialGroups = {};
            orders.forEach(order => {
                if (!materialGroups[order.material]) {
                    materialGroups[order.material] = [];
                }
                materialGroups[order.material].push(order);
            });

            let optimizationReport = '🎯 バッチ最適化提案\n\n';
            let batchCount = 0;

            Object.keys(materialGroups).forEach(material => {
                const orders = materialGroups[material];
                const totalWeight = orders.reduce((sum, order) => sum + order.totalWeight, 0);
                const batchesNeeded = Math.ceil(totalWeight / 300);
                
                optimizationReport += `📦 ${material}材質:\n`;
                optimizationReport += `  • 注文数: ${orders.length}件\n`;
                optimizationReport += `  • 総重量: ${totalWeight.toFixed(1)}kg\n`;
                optimizationReport += `  • 推奨バッチ数: ${batchesNeeded}バッチ\n`;
                optimizationReport += `  • 平均バッチ重量: ${(totalWeight / batchesNeeded).toFixed(1)}kg\n\n`;
                
                batchCount += batchesNeeded;
            });

            optimizationReport += `📊 最適化結果:\n`;
            optimizationReport += `• 総バッチ数: ${batchCount}バッチ\n`;
            optimizationReport += `• 効率評価: ${batchCount <= Object.keys(materialGroups).length * 2 ? '良好' : '要改善'}\n`;

            alert(optimizationReport);
            showNotification('バッチ最適化を実行しました', 'info');
        }

        // 通知表示機能
        function showNotification(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1100';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // フィルター・ソート機能
        function applyFilters() {
            const materialFilter = document.getElementById('materialFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();

            filteredOrders = orders.filter(order => {
                const materialMatch = !materialFilter || order.material === materialFilter;
                const statusMatch = !statusFilter || order.status === statusFilter;
                const searchMatch = !searchText ||
                    order.productName.toLowerCase().includes(searchText) ||
                    order.productCode.toLowerCase().includes(searchText) ||
                    order.orderNumber.toLowerCase().includes(searchText);

                return materialMatch && statusMatch && searchMatch;
            });

            updateTable();
        }

        function clearFilters() {
            document.getElementById('materialFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchBox').value = '';
            filteredOrders = [...orders];
            updateTable();
        }

        function sortTable(field) {
            filteredOrders.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'deliveryDate') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });

            updateTable();
        }

        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('newOrderNumber').value = order.orderNumber;
            document.getElementById('newCustomer').value = order.customer || '';
            document.getElementById('newProductCode').value = order.productCode;
            document.getElementById('newProductName').value = order.productName;
            document.getElementById('newMaterial').value = order.material;
            document.getElementById('newUnitWeight').value = order.unitWeight;
            document.getElementById('newQuantity').value = order.quantity;
            document.getElementById('newOrderDate').value = order.orderDate || '';
            document.getElementById('newDeliveryDate').value = order.deliveryDate;
            document.getElementById('newNotes').value = order.notes || '';

            deleteOrder(id, false);
            new bootstrap.Modal(document.getElementById('addOrderModal')).show();
        }

        function deleteOrder(id, showConfirm = true) {
            if (showConfirm && !confirm('この注文を削除しますか？')) return;

            orders = orders.filter(o => o.id !== id);
            filteredOrders = filteredOrders.filter(o => o.id !== id);
            saveData();
            updateDashboard();
            updateTable();

            if (showConfirm) {
                showNotification('注文を削除しました', 'info');
            }
        }

        // === 初期化とサンプルデータ ===
        
        // 全データ読み込み
        loadAllData();
        
        // 注文サンプルデータ初期化
        if (orders.length === 0) {
            orders = [
                {
                    id: 'MN002BUV',
                    orderNumber: 'MN002BUV',
                    customer: '株式会社田中製作所',
                    productCode: 'P815-110-0162',
                    productName: 'コネクタ VLN-15',
                    material: 'S14',
                    unitWeight: 13.2,
                    quantity: 2,
                    totalWeight: 26.4,
                    orderDate: '2025-01-10',
                    deliveryDate: '2025-01-31',
                    status: 'pending',
                    notes: '25.4.9在庫3ケ仕上済'
                },
                {
                    id: 'MH002BVD',
                    orderNumber: 'MH002BVD',
                    customer: '佐藤工業株式会社',
                    productCode: 'P895-110-0163',
                    productName: 'コネクタ VLN-5',
                    material: 'FCD450',
                    unitWeight: 7.3,
                    quantity: 16,
                    totalWeight: 116.8,
                    orderDate: '2025-01-15',
                    deliveryDate: '2025-02-28',
                    status: 'pending',
                    notes: ''
                },
                {
                    id: 'FL003CVX',
                    orderNumber: 'FL003CVX',
                    customer: '山田機械工業',
                    productCode: 'P920-150-0045',
                    productName: 'フランジ CF-8',
                    material: 'SCPH2',
                    unitWeight: 25.4,
                    quantity: 8,
                    totalWeight: 203.2,
                    orderDate: '2025-01-12',
                    deliveryDate: '2025-02-15',
                    status: 'processing',
                    notes: '特急案件'
                }
            ];
            saveData();
        }

        // 製品データ初期化
        if (products.length === 0) {
            products = [
                {
                    id: 'PROD-001',
                    productCode: 'P815-110-0162',
                    productName: 'コネクタ VLN-15',
                    category: 'コネクタ',
                    material: 'S14',
                    unitWeight: 13.2,
                    standardPrice: 15000,
                    description: 'VLシリーズ 15mm径コネクタ',
                    specifications: '径15mm、長さ50mm',
                    drawingNumber: 'DRW-815-110',
                    status: 'active',
                    createdDate: '2025-01-01',
                    updatedDate: '2025-01-10'
                },
                {
                    id: 'PROD-002',
                    productCode: 'P895-110-0163',
                    productName: 'コネクタ VLN-5',
                    category: 'コネクタ',
                    material: 'FCD450',
                    unitWeight: 7.3,
                    standardPrice: 8500,
                    description: 'VLシリーズ 5mm径コネクタ',
                    specifications: '径5mm、長さ30mm',
                    drawingNumber: 'DRW-895-110',
                    status: 'active',
                    createdDate: '2025-01-01',
                    updatedDate: '2025-01-05'
                },
                {
                    id: 'PROD-003',
                    productCode: 'P920-150-0045',
                    productName: 'フランジ CF-8',
                    category: 'フランジ',
                    material: 'SCPH2',
                    unitWeight: 25.4,
                    standardPrice: 45000,
                    description: 'CF-8フランジ 耐圧仕様',
                    specifications: '外径150mm、厚み20mm',
                    drawingNumber: 'DRW-920-150',
                    status: 'active',
                    createdDate: '2025-01-01',
                    updatedDate: '2025-01-12'
                }
            ];
            saveProductData();
        }

        // 取引先データ初期化
        if (customers.length === 0) {
            customers = [
                {
                    id: 'CUST-001',
                    customerCode: 'C001',
                    companyName: '株式会社田中製作所',
                    companyNameKana: 'カブシキガイシャタナカセイサクショ',
                    contactPerson: '田中 太郎',
                    department: '調達部',
                    email: 'tanaka@tanaka-mfg.co.jp',
                    phone: '03-1234-5678',
                    fax: '03-1234-5679',
                    zipCode: '100-0001',
                    address: '東京都千代田区千代田1-1-1',
                    paymentTerms: '月末締め翌月末払い',
                    creditLimit: 5000000,
                    taxType: '内税',
                    discountRate: 5,
                    status: 'active',
                    createdDate: '2024-01-15',
                    updatedDate: '2025-01-10'
                },
                {
                    id: 'CUST-002',
                    customerCode: 'C002',
                    companyName: '佐藤工業株式会社',
                    companyNameKana: 'サトウコウギョウカブシキガイシャ',
                    contactPerson: '佐藤 花子',
                    department: '資材部',
                    email: 'sato@sato-ind.co.jp',
                    phone: '045-987-6543',
                    fax: '045-987-6544',
                    zipCode: '220-0001',
                    address: '神奈川県横浜市西区西1-2-3',
                    paymentTerms: '20日締め翌月10日払い',
                    creditLimit: 3000000,
                    taxType: '外税',
                    discountRate: 3,
                    status: 'active',
                    createdDate: '2024-03-20',
                    updatedDate: '2025-01-15'
                },
                {
                    id: 'CUST-003',
                    customerCode: 'C003',
                    companyName: '山田機械工業',
                    companyNameKana: 'ヤマダキカイコウギョウ',
                    contactPerson: '山田 次郎',
                    department: '購買課',
                    email: 'yamada@yamada-mach.co.jp',
                    phone: '06-5555-1111',
                    fax: '06-5555-1112',
                    zipCode: '550-0001',
                    address: '大阪府大阪市西区西本町1-4-5',
                    paymentTerms: '月末締め翌々月末払い',
                    creditLimit: 8000000,
                    taxType: '内税',
                    discountRate: 7,
                    status: 'active',
                    createdDate: '2024-06-10',
                    updatedDate: '2025-01-12'
                }
            ];
            saveCustomerData();
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-gear-fill"></i> ステンレス鋳造管理システム</a>
            <span class="navbar-text"><i class="bi bi-circle-fill text-success"></i> システム稼働中</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ナビゲーションタブ -->
        <div class="row mb-3">
            <div class="col-12">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button" role="tab">
                            <i class="bi bi-list-ul"></i> 注文管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button" role="tab">
                            <i class="bi bi-box"></i> 製品管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers-pane" type="button" role="tab">
                            <i class="bi bi-people"></i> 取引先管理
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- タブコンテンツ -->
        <div class="tab-content" id="mainTabContent">
            <!-- 注文管理タブ -->
            <div class="tab-pane fade show active" id="orders-pane" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" onclick="showAddOrderModal()"><i class="bi bi-plus-circle"></i> 新規注文追加</button>
                            <button class="btn btn-warning" onclick="showPDFModal()"><i class="bi bi-file-pdf"></i> PDF読み取り</button>
                            <button class="btn btn-info" onclick="showExcelModal()"><i class="bi bi-file-spreadsheet"></i> Excel取込</button>
                            <button class="btn btn-secondary" onclick="exportToCSV()"><i class="bi bi-download"></i> CSVエクスポート</button>
                            <button class="btn btn-primary" onclick="runBatchOptimization()"><i class="bi bi-lightning"></i> バッチ最適化</button>
                        </div>
                    </div>
                </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body"><h5>未完了注文数</h5><h2 id="orderCount">0</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body"><h5>総重量</h5><h2 id="totalWeight">0 kg</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body"><h5>緊急納期件数</h5><h2 id="urgentCount">0</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body"><h5>推奨バッチ数</h5><h2 id="batchCount">0</h2></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header"><h5><i class="bi bi-funnel"></i> フィルター・検索</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="materialFilter" onchange="applyFilters()">
                                    <option value="">全材質</option>
                                    <option value="S14">S14</option>
                                    <option value="SCS">SCS</option>
                                    <option value="SUS304">SUS304</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                    <option value="">全状態</option>
                                    <option value="pending">未処理</option>
                                    <option value="processing">処理中</option>
                                    <option value="completed">完了</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchBox" placeholder="品名・品番で検索..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()"><i class="bi bi-x-circle"></i> クリア</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header"><h5><i class="bi bi-robot"></i> AIアシスタント</h5></div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container mb-3">
                            <div class="message-ai">こんにちは！「S14材を表示」「緊急の注文は？」などお聞きください。</div>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" id="chatInput" rows="3" placeholder="質問を入力してください...例：'S14材の注文を表示'、'緊急の注文は？'" onkeypress="handleChatKeyPress(event)"></textarea>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="insertQuickQuery('S14材を表示')">S14材</button>
                                <button class="btn btn-outline-secondary" onclick="insertQuickQuery('緊急の注文は？')">緊急</button>
                                <button class="btn btn-outline-secondary" onclick="insertQuickQuery('総重量を教えて')">重量</button>
                            </div>
                            <button class="btn btn-primary" onclick="sendChatMessage()" id="sendButton">
                                <i class="bi bi-send"></i> 送信
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-table"></i> 注文管理一覧</h5>
                <span class="badge bg-primary" id="displayCount">0件表示</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortTable('customer')">発注者 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('orderNumber')">注文番号 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('productCode')">品番 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('productName')">品名 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('material')">材質 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('unitWeight')">単重量 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('quantity')">数量 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('totalWeight')">総重量 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('orderDate')">発注日 <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('deliveryDate')">納期 <i class="bi bi-arrow-down-up"></i></th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
            </div>
            <!-- 注文管理タブ終了 -->

            <!-- 製品管理タブ -->
            <div class="tab-pane fade" id="products-pane" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" onclick="showAddProductModal()"><i class="bi bi-plus-circle"></i> 製品追加</button>
                            <button class="btn btn-info" onclick="showExcelProductModal()"><i class="bi bi-file-spreadsheet"></i> Excel取込</button>
                            <button class="btn btn-secondary" onclick="exportProductsToCSV()"><i class="bi bi-download"></i> CSVエクスポート</button>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body"><h5>製品総数</h5><h2 id="productCount">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body"><h5>有効製品</h5><h2 id="activeProductCount">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-warning text-white">
                            <div class="card-body"><h5>製品カテゴリ</h5><h2 id="categoryCount">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body"><h5>平均単価</h5><h2 id="avgPrice">¥0</h2></div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header"><h5><i class="bi bi-funnel"></i> 製品フィルター・検索</h5></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <select class="form-select" id="productCategoryFilter" onchange="applyProductFilters()">
                                            <option value="">すべてのカテゴリ</option>
                                            <option value="コネクタ">コネクタ</option>
                                            <option value="バルブ">バルブ</option>
                                            <option value="継手">継手</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="productStatusFilter" onchange="applyProductFilters()">
                                            <option value="">すべてのステータス</option>
                                            <option value="active">有効</option>
                                            <option value="discontinued">製造中止</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="productSearchBox" placeholder="製品名・品番で検索" onkeyup="applyProductFilters()">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearProductFilters()">フィルタークリア</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-box"></i> 製品一覧</h5>
                        <span class="badge bg-success" id="productDisplayCount">0件表示</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th onclick="sortProductTable('productCode')">品番 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortProductTable('productName')">製品名 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortProductTable('category')">カテゴリ <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortProductTable('material')">材質 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortProductTable('unitWeight')">単重量 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortProductTable('standardPrice')">標準価格 <i class="bi bi-arrow-down-up"></i></th>
                                        <th>ステータス</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 製品管理タブ終了 -->

            <!-- 取引先管理タブ -->
            <div class="tab-pane fade" id="customers-pane" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" onclick="showAddCustomerModal()"><i class="bi bi-plus-circle"></i> 取引先追加</button>
                            <button class="btn btn-info" onclick="showExcelCustomerModal()"><i class="bi bi-file-spreadsheet"></i> Excel取込</button>
                            <button class="btn btn-secondary" onclick="exportCustomersToCSV()"><i class="bi bi-download"></i> CSVエクスポート</button>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body"><h5>取引先総数</h5><h2 id="customerCount">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body"><h5>アクティブ</h5><h2 id="activeCustomerCount">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body"><h5>月間平均注文</h5><h2 id="avgMonthlyOrders">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-warning text-white">
                            <div class="card-body"><h5>総注文実績</h5><h2 id="totalOrders">0件</h2></div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header"><h5><i class="bi bi-funnel"></i> 取引先フィルター・検索</h5></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <select class="form-select" id="customerTypeFilter" onchange="applyCustomerFilters()">
                                            <option value="">すべてのタイプ</option>
                                            <option value="direct">直接取引</option>
                                            <option value="agent">代理店</option>
                                            <option value="distributor">販売店</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="customerStatusFilter" onchange="applyCustomerFilters()">
                                            <option value="">すべてのステータス</option>
                                            <option value="active">アクティブ</option>
                                            <option value="inactive">非アクティブ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="customerSearchBox" placeholder="会社名・担当者で検索" onkeyup="applyCustomerFilters()">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="clearCustomerFilters()">フィルタークリア</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-people"></i> 取引先一覧</h5>
                        <span class="badge bg-primary" id="customerDisplayCount">0件表示</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th onclick="sortCustomerTable('customerCode')">取引先コード <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortCustomerTable('companyName')">会社名 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortCustomerTable('contactPerson')">担当者 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortCustomerTable('email')">連絡先 <i class="bi bi-arrow-down-up"></i></th>
                                        <th onclick="sortCustomerTable('totalOrders')">注文実績 <i class="bi bi-arrow-down-up"></i></th>
                                        <th>ステータス</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 取引先管理タブ終了 -->
        </div>
        <!-- タブコンテンツ終了 -->
    </div>

    <!-- モーダル各種 -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新規注文追加</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addOrderForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">注文番号 *</label>
                                    <input type="text" class="form-control" id="newOrderNumber" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">発注者</label>
                                    <input type="text" class="form-control" id="newCustomer" placeholder="取引先名を入力">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">品番 *</label>
                                    <input type="text" class="form-control" id="newProductCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">品名 *</label>
                                    <input type="text" class="form-control" id="newProductName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">材質 *</label>
                                    <select class="form-select" id="newMaterial" required>
                                        <option value="">選択してください</option>
                                        <option value="S13">S13</option>
                                        <option value="S14">S14</option>
                                        <option value="S15">S15</option>
                                        <option value="SCS13">SCS13</option>
                                        <option value="SCS14">SCS14</option>
                                        <option value="SUS304">SUS304</option>
                                        <option value="SUS316">SUS316</option>
                                        <option value="FC200">FC200</option>
                                        <option value="FC250">FC250</option>
                                        <option value="FC300">FC300</option>
                                        <option value="FC400">FC400</option>
                                        <option value="FCD400">FCD400</option>
                                        <option value="FCD450">FCD450</option>
                                        <option value="FCD500">FCD500</option>
                                        <option value="SCPH1">SCPH1</option>
                                        <option value="SCPH2">SCPH2</option>
                                        <option value="SCPH11">SCPH11</option>
                                        <option value="SCPH12">SCPH12</option>
                                        <option value="SCPH13">SCPH13</option>
                                        <option value="その他">その他（手入力）</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">単重量 (kg) *</label>
                                    <input type="number" class="form-control" id="newUnitWeight" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">数量 *</label>
                                    <input type="number" class="form-control" id="newQuantity" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">発注日</label>
                                    <input type="date" class="form-control" id="newOrderDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">納期 *</label>
                                    <input type="date" class="form-control" id="newDeliveryDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備考</label>
                            <textarea class="form-control" id="newNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-success" onclick="saveNewOrder()"><i class="bi bi-check-circle"></i> 追加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF読み込みモーダル -->
    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-pdf text-danger"></i> PDF読み込み・データ抽出
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- PDF アップロード部分 -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="bi bi-upload"></i> PDFファイル選択</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="pdfFileInput" class="form-label">PDFファイルを選択</label>
                                        <input type="file" class="form-control" id="pdfFileInput" accept=".pdf" onchange="handlePDFFileSelect(event)">
                                        <div class="form-text">
                                            注文書・仕様書などのPDFファイルをアップロードしてください
                                        </div>
                                    </div>
                                    
                                    <div id="pdfProcessingStatus" class="alert alert-info d-none">
                                        <i class="bi bi-hourglass-split"></i> PDFを解析中...
                                    </div>
                                    
                                    <div id="pdfPreview" class="border rounded p-3 bg-light d-none">
                                        <h6>プレビュー</h6>
                                        <canvas id="pdfCanvas" class="w-100"></canvas>
                                        <div class="mt-2">
                                            <small class="text-muted">ページ: <span id="pdfPageInfo">-</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 抽出データ部分 -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="bi bi-table"></i> 抽出データ</h6>
                                </div>
                                <div class="card-body">
                                    <div id="extractedDataContainer" class="d-none">
                                        <form id="pdfExtractedForm">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">注文番号</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfOrderNumber">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">発注者</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfCustomer">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">品番</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfProductCode">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">品名</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfProductName">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">材質</label>
                                                        <select class="form-select form-select-sm" id="pdfMaterial">
                                                            <option value="">選択</option>
                                                            <option value="S14">S14</option>
                                                            <option value="SCS">SCS</option>
                                                            <option value="SUS304">SUS304</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">単重量(kg)</label>
                                                        <input type="number" class="form-control form-control-sm" id="pdfUnitWeight" step="0.1">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">数量</label>
                                                        <input type="number" class="form-control form-control-sm" id="pdfQuantity">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">納期</label>
                                                <input type="date" class="form-control form-control-sm" id="pdfDeliveryDate">
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">備考</label>
                                                <textarea class="form-control form-control-sm" id="pdfNotes" rows="2"></textarea>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div id="noDataMessage" class="text-center text-muted">
                                        <i class="bi bi-file-text fs-1"></i>
                                        <p>PDFファイルを選択すると、データが自動抽出されます</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 抽出されたテキスト（デバッグ用） -->
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-code"></i> 抽出テキスト（確認用）</h6>
                            </div>
                            <div class="card-body">
                                <textarea id="extractedText" class="form-control" rows="4" readonly placeholder="PDFから抽出されたテキストがここに表示されます..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> キャンセル
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addOrderFromPDF()" id="addFromPDFBtn" disabled>
                        <i class="bi bi-plus-circle"></i> 注文として追加
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel取込モーダル -->
    <div class="modal fade" id="excelModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-spreadsheet text-success"></i> Excel・CSV取込・データ抽出
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Excel アップロード部分 -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="bi bi-upload"></i> Excelファイル選択</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="excelFileInput" class="form-label">Excel・CSVファイルを選択</label>
                                        <input type="file" class="form-control" id="excelFileInput" 
                                               accept=".xlsx,.xls,.csv" onchange="handleExcelFileSelect(event)">
                                        <div class="form-text">
                                            Excel（.xlsx, .xls）またはCSV（.csv）ファイルをアップロードしてください
                                        </div>
                                    </div>
                                    
                                    <div id="excelProcessingStatus" class="alert alert-info d-none">
                                        <i class="bi bi-hourglass-split"></i> Excelファイルを解析中...
                                    </div>
                                    
                                    <div id="excelPreview" class="border rounded p-3 bg-light d-none">
                                        <h6>ファイル情報</h6>
                                        <div id="excelFileInfo"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 抽出データプレビュー部分 -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="bi bi-table"></i> データプレビュー</h6>
                                </div>
                                <div class="card-body">
                                    <div id="excelNoDataMessage" class="text-center text-muted">
                                        <i class="bi bi-file-spreadsheet fs-1"></i>
                                        <p>Excelファイルを選択すると、データが自動抽出されプレビューされます</p>
                                        <small class="text-muted">
                                            ヘッダー行に「注文番号」「品番」「品名」「材質」「数量」などの列名を含めてください
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 抽出されたデータ表示エリア -->
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-grid"></i> 抽出データ一覧</h6>
                            </div>
                            <div class="card-body">
                                <div id="excelExtractedDataContainer" class="d-none">
                                    <!-- 動的に生成されるテーブル -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> キャンセル
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addAllOrdersFromExcel()" id="addFromExcelBtn" disabled>
                        <i class="bi bi-plus-circle"></i> データを追加
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 取引先編集モーダル -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil text-primary"></i> 取引先編集
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCustomerCode" class="form-label">取引先コード *</label>
                                    <input type="text" class="form-control" id="editCustomerCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCompanyName" class="form-label">会社名 *</label>
                                    <input type="text" class="form-control" id="editCompanyName" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editContactPerson" class="form-label">担当者名 *</label>
                                    <input type="text" class="form-control" id="editContactPerson" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDepartment" class="form-label">部署名</label>
                                    <input type="text" class="form-control" id="editDepartment">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPhone" class="form-label">電話番号 *</label>
                                    <input type="tel" class="form-control" id="editPhone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEmail" class="form-label">メールアドレス *</label>
                                    <input type="email" class="form-control" id="editEmail" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="editPostalCode" class="form-label">郵便番号</label>
                                    <input type="text" class="form-control" id="editPostalCode" placeholder="000-0000">
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="mb-3">
                                    <label for="editAddress" class="form-label">住所</label>
                                    <input type="text" class="form-control" id="editAddress">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPaymentTerms" class="form-label">支払条件</label>
                                    <select class="form-select" id="editPaymentTerms">
                                        <option value="月末締め翌月末払い">月末締め翌月末払い</option>
                                        <option value="20日締め翌月10日払い">20日締め翌月10日払い</option>
                                        <option value="15日締め翌月末払い">15日締め翌月末払い</option>
                                        <option value="末日締め翌々月5日払い">末日締め翌々月5日払い</option>
                                        <option value="月末締め翌月20日払い">月末締め翌月20日払い</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTaxType" class="form-label">税区分</label>
                                    <select class="form-select" id="editTaxType">
                                        <option value="外税">外税</option>
                                        <option value="内税">内税</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCustomerType" class="form-label">取引先種別</label>
                                    <select class="form-select" id="editCustomerType">
                                        <option value="direct">直接取引</option>
                                        <option value="agent">代理店</option>
                                        <option value="distributor">販売店</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStatus" class="form-label">ステータス</label>
                                    <select class="form-select" id="editStatus">
                                        <option value="active">アクティブ</option>
                                        <option value="inactive">非アクティブ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">備考</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                        
                        <input type="hidden" id="editCustomerId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> キャンセル
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">
                        <i class="bi bi-check-circle"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 外部ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // === 製品データと取引先データの初期化 ===
        
        // 製品データ初期化
        function initializeProductData() {
            products = [
                {
                    id: 1,
                    productCode: 'P815-110-0162',
                    productName: 'コネクタ VLN-15',
                    category: 'コネクタ',
                    material: 'S14',
                    unitWeight: 13.2,
                    standardPrice: 15000,
                    description: '高圧用ステンレスコネクタ',
                    specifications: 'φ15mm, 耐圧1.5MPa',
                    drawingNumber: 'D-VLN-15-001',
                    status: 'active',
                    createdDate: '2024-01-15',
                    modifiedDate: '2024-12-01'
                },
                {
                    id: 2,
                    productCode: 'P895-110-0163',
                    productName: 'コネクタ VLN-5',
                    category: 'コネクタ',
                    material: 'S14',
                    unitWeight: 7.3,
                    standardPrice: 8500,
                    description: '中圧用ステンレスコネクタ',
                    specifications: 'φ5mm, 耐圧1.0MPa',
                    drawingNumber: 'D-VLN-5-001',
                    status: 'active',
                    createdDate: '2024-02-10',
                    modifiedDate: '2024-11-15'
                },
                {
                    id: 3,
                    productCode: 'SCH11',
                    productName: 'エアレジメンテ（2個セット）',
                    category: 'バルブ',
                    material: 'S13',
                    unitWeight: 10.5,
                    standardPrice: 22000,
                    description: 'エア調整用レジデューサ',
                    specifications: '2個1組、φ8mm',
                    drawingNumber: 'D-SCH11-001',
                    status: 'active',
                    createdDate: '2024-03-05',
                    modifiedDate: '2024-10-20'
                },
                {
                    id: 4,
                    productCode: 'P893-110-0162',
                    productName: 'コネクタ VLN-3（4個セット）',
                    category: 'コネクタ',
                    material: 'S13',
                    unitWeight: 6.0,
                    standardPrice: 18000,
                    description: '小径ステンレスコネクタセット',
                    specifications: 'φ3mm×4個, 耐圧0.8MPa',
                    drawingNumber: 'D-VLN-3-001',
                    status: 'active',
                    createdDate: '2024-04-20',
                    modifiedDate: '2024-09-30'
                },
                {
                    id: 5,
                    productCode: 'FCV-25',
                    productName: 'フローコントロールバルブ',
                    category: 'バルブ',
                    material: 'FCD450',
                    unitWeight: 45.0,
                    standardPrice: 85000,
                    description: '流量制御用大型バルブ',
                    specifications: 'φ25mm, 最大流量100L/min',
                    drawingNumber: 'D-FCV-25-001',
                    status: 'active',
                    createdDate: '2024-05-10',
                    modifiedDate: '2024-08-15'
                }
            ];
            
            filteredProducts = [...products];
            console.log('製品データ初期化完了:', products.length + '件');
        }

        // 取引先データ初期化
        function initializeCustomerData() {
            customers = [
                {
                    id: 1,
                    customerCode: 'C001',
                    companyName: '東京機械工業株式会社',
                    contactPerson: '田中 太郎',
                    department: '購買部',
                    phone: '03-1234-5678',
                    email: 'tanaka@tokyo-machinery.co.jp',
                    address: '東京都港区芝公園1-2-3',
                    postalCode: '105-0011',
                    paymentTerms: '月末締め翌月末払い',
                    taxType: '外税',
                    customerType: 'direct',
                    status: 'active',
                    notes: '主要取引先、月間定期発注あり',
                    lastOrderDate: '2025-01-15',
                    totalOrders: 145,
                    createdDate: '2020-04-01',
                    modifiedDate: '2024-12-15'
                },
                {
                    id: 2,
                    customerCode: 'C002',
                    companyName: '大阪製作所',
                    contactPerson: '佐藤 花子',
                    department: '調達課',
                    phone: '06-8765-4321',
                    email: 'sato@osaka-mfg.com',
                    address: '大阪府大阪市北区梅田2-4-6',
                    postalCode: '530-0001',
                    paymentTerms: '20日締め翌月10日払い',
                    taxType: '内税',
                    customerType: 'agent',
                    status: 'active',
                    notes: '代理店経由、特注品多め',
                    lastOrderDate: '2025-01-10',
                    totalOrders: 78,
                    createdDate: '2021-06-15',
                    modifiedDate: '2024-11-20'
                },
                {
                    id: 3,
                    customerCode: 'C003',
                    companyName: '名古屋産業株式会社',
                    contactPerson: '鈴木 一郎',
                    department: '資材部',
                    phone: '052-3456-7890',
                    email: 'suzuki@nagoya-ind.co.jp',
                    address: '愛知県名古屋市中区栄3-15-33',
                    postalCode: '460-0008',
                    paymentTerms: '末日締め翌々月5日払い',
                    taxType: '外税',
                    customerType: 'distributor',
                    status: 'active',
                    notes: '販売店、小ロット多数',
                    lastOrderDate: '2024-12-28',
                    totalOrders: 203,
                    createdDate: '2019-08-10',
                    modifiedDate: '2024-10-05'
                },
                {
                    id: 4,
                    customerCode: 'C004',
                    companyName: '九州エンジニアリング',
                    contactPerson: '高橋 美代子',
                    department: '技術部',
                    phone: '092-9876-5432',
                    email: 'takahashi@kyushu-eng.com',
                    address: '福岡県福岡市博多区駅前1-1-1',
                    postalCode: '812-0011',
                    paymentTerms: '15日締め翌月末払い',
                    taxType: '外税',
                    customerType: 'direct',
                    status: 'active',
                    notes: '技術要求レベル高、高精度品中心',
                    lastOrderDate: '2025-01-08',
                    totalOrders: 96,
                    createdDate: '2022-02-28',
                    modifiedDate: '2024-12-10'
                },
                {
                    id: 5,
                    customerCode: 'C005',
                    companyName: '北海道機工',
                    contactPerson: '渡辺 次郎',
                    department: '営業部',
                    phone: '011-2468-1357',
                    email: 'watanabe@hokkaido-eng.co.jp',
                    address: '北海道札幌市中央区大通西10-4',
                    postalCode: '060-0042',
                    paymentTerms: '月末締め翌月20日払い',
                    taxType: '内税',
                    customerType: 'agent',
                    status: 'inactive',
                    notes: '冬季限定取引、現在休止中',
                    lastOrderDate: '2024-10-15',
                    totalOrders: 34,
                    createdDate: '2023-05-12',
                    modifiedDate: '2024-10-15'
                }
            ];
            
            filteredCustomers = [...customers];
            console.log('取引先データ初期化完了:', customers.length + '件');
        }

        // === 製品管理機能 ===
        
        function updateProductDashboard() {
            const activeProducts = products.filter(p => p.status === 'active');
            const categories = [...new Set(products.map(p => p.category))];
            const avgPrice = products.length > 0 ? 
                Math.round(products.reduce((sum, p) => sum + p.standardPrice, 0) / products.length) : 0;

            document.getElementById('productCount').textContent = products.length;
            document.getElementById('activeProductCount').textContent = activeProducts.length;
            document.getElementById('categoryCount').textContent = categories.length;
            document.getElementById('avgPrice').textContent = '¥' + avgPrice.toLocaleString();
        }

        function updateProductTable() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            document.getElementById('productDisplayCount').textContent = filteredProducts.length + '件表示';

            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${product.productCode}</code></td>
                    <td>${product.productName}</td>
                    <td><span class="badge bg-info">${product.category}</span></td>
                    <td><span class="badge ${product.material === 'S14' ? 'bg-primary' : product.material === 'S13' ? 'bg-success' : 'bg-warning'}">${product.material}</span></td>
                    <td>${product.unitWeight}kg</td>
                    <td>¥${product.standardPrice.toLocaleString()}</td>
                    <td><span class="badge ${product.status === 'active' ? 'bg-success' : 'bg-secondary'}">${product.status === 'active' ? '有効' : '製造中止'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyProductFilters() {
            const categoryFilter = document.getElementById('productCategoryFilter').value;
            const statusFilter = document.getElementById('productStatusFilter').value;
            const searchText = document.getElementById('productSearchBox').value.toLowerCase();

            filteredProducts = products.filter(product => {
                const categoryMatch = !categoryFilter || product.category === categoryFilter;
                const statusMatch = !statusFilter || product.status === statusFilter;
                const searchMatch = !searchText ||
                    product.productName.toLowerCase().includes(searchText) ||
                    product.productCode.toLowerCase().includes(searchText);

                return categoryMatch && statusMatch && searchMatch;
            });

            updateProductTable();
        }

        function clearProductFilters() {
            document.getElementById('productCategoryFilter').value = '';
            document.getElementById('productStatusFilter').value = '';
            document.getElementById('productSearchBox').value = '';
            filteredProducts = [...products];
            updateProductTable();
        }

        function sortProductTable(field) {
            filteredProducts.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });
            
            updateProductTable();
        }

        // === 取引先管理機能 ===
        
        function updateCustomerDashboard() {
            const activeCustomers = customers.filter(c => c.status === 'active');
            const avgMonthlyOrders = customers.length > 0 ? 
                Math.round(customers.reduce((sum, c) => sum + c.totalOrders, 0) / customers.length / 12) : 0;
            const totalOrdersCount = customers.reduce((sum, c) => sum + c.totalOrders, 0);

            document.getElementById('customerCount').textContent = customers.length;
            document.getElementById('activeCustomerCount').textContent = activeCustomers.length;
            document.getElementById('avgMonthlyOrders').textContent = avgMonthlyOrders;
            document.getElementById('totalOrders').textContent = totalOrdersCount + '件';
        }

        function updateCustomerTable() {
            const tbody = document.getElementById('customersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            document.getElementById('customerDisplayCount').textContent = filteredCustomers.length + '件表示';

            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${customer.customerCode}</code></td>
                    <td>${customer.companyName}</td>
                    <td>${customer.contactPerson}</td>
                    <td>
                        <div>${customer.email}</div>
                        <small class="text-muted">${customer.phone}</small>
                    </td>
                    <td>${customer.totalOrders}件</td>
                    <td><span class="badge ${customer.status === 'active' ? 'bg-success' : 'bg-secondary'}">${customer.status === 'active' ? 'アクティブ' : '非アクティブ'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${customer.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${customer.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyCustomerFilters() {
            const typeFilter = document.getElementById('customerTypeFilter').value;
            const statusFilter = document.getElementById('customerStatusFilter').value;
            const searchText = document.getElementById('customerSearchBox').value.toLowerCase();

            filteredCustomers = customers.filter(customer => {
                const typeMatch = !typeFilter || customer.customerType === typeFilter;
                const statusMatch = !statusFilter || customer.status === statusFilter;
                const searchMatch = !searchText ||
                    customer.companyName.toLowerCase().includes(searchText) ||
                    customer.contactPerson.toLowerCase().includes(searchText);

                return typeMatch && statusMatch && searchMatch;
            });

            updateCustomerTable();
        }

        function clearCustomerFilters() {
            document.getElementById('customerTypeFilter').value = '';
            document.getElementById('customerStatusFilter').value = '';
            document.getElementById('customerSearchBox').value = '';
            filteredCustomers = [...customers];
            updateCustomerTable();
        }

        function sortCustomerTable(field) {
            filteredCustomers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });
            
            updateCustomerTable();
        }

        // === プレースホルダー関数（モーダル表示等） ===
        
        function showAddProductModal() {
            alert('製品追加機能は今後実装予定です');
        }

        function showExcelProductModal() {
            alert('製品Excel取込機能は今後実装予定です');
        }

        function exportProductsToCSV() {
            alert('製品CSVエクスポート機能は今後実装予定です');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                alert(`製品編集: ${product.productName}\n(ID: ${id})\n※編集機能は今後実装予定です`);
            }
        }

        function deleteProduct(id) {
            if (confirm('この製品を削除しますか？')) {
                products = products.filter(p => p.id !== id);
                filteredProducts = [...products];
                updateProductTable();
                updateProductDashboard();
                showNotification('製品を削除しました', 'success');
            }
        }

        function showAddCustomerModal() {
            alert('取引先追加機能は今後実装予定です');
        }

        function showExcelCustomerModal() {
            alert('取引先Excel取込機能は今後実装予定です');
        }

        function exportCustomersToCSV() {
            alert('取引先CSVエクスポート機能は今後実装予定です');
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                // フォームに現在の値を設定
                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCustomerCode').value = customer.customerCode;
                document.getElementById('editCompanyName').value = customer.companyName;
                document.getElementById('editContactPerson').value = customer.contactPerson;
                document.getElementById('editDepartment').value = customer.department || '';
                document.getElementById('editPhone').value = customer.phone;
                document.getElementById('editEmail').value = customer.email;
                document.getElementById('editPostalCode').value = customer.postalCode || '';
                document.getElementById('editAddress').value = customer.address || '';
                document.getElementById('editPaymentTerms').value = customer.paymentTerms || '月末締め翌月末払い';
                document.getElementById('editTaxType').value = customer.taxType || '外税';
                document.getElementById('editCustomerType').value = customer.customerType || 'direct';
                document.getElementById('editStatus').value = customer.status || 'active';
                document.getElementById('editNotes').value = customer.notes || '';
                
                // モーダルを表示
                const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
                modal.show();
            }
        }

        function saveCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const customerIndex = customers.findIndex(c => c.id == id);
            
            if (customerIndex !== -1) {
                // フォームバリデーション
                const customerCode = document.getElementById('editCustomerCode').value.trim();
                const companyName = document.getElementById('editCompanyName').value.trim();
                const contactPerson = document.getElementById('editContactPerson').value.trim();
                const phone = document.getElementById('editPhone').value.trim();
                const email = document.getElementById('editEmail').value.trim();
                
                // 必須フィールドチェック
                if (!customerCode || !companyName || !contactPerson || !phone || !email) {
                    showNotification('必須フィールドをすべて入力してください', 'error');
                    return;
                }
                
                // 取引先コードの重複チェック（自分以外）
                const existingCustomer = customers.find(c => c.customerCode === customerCode && c.id != id);
                if (existingCustomer) {
                    showNotification('この取引先コードは既に使用されています', 'error');
                    return;
                }
                
                // メールアドレスの形式チェック
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) {
                    showNotification('有効なメールアドレスを入力してください', 'error');
                    return;
                }
                
                // フォームの値を取得
                const updatedCustomer = {
                    ...customers[customerIndex],
                    customerCode: customerCode,
                    companyName: companyName,
                    contactPerson: contactPerson,
                    department: document.getElementById('editDepartment').value.trim(),
                    phone: phone,
                    email: email,
                    postalCode: document.getElementById('editPostalCode').value.trim(),
                    address: document.getElementById('editAddress').value.trim(),
                    paymentTerms: document.getElementById('editPaymentTerms').value,
                    taxType: document.getElementById('editTaxType').value,
                    customerType: document.getElementById('editCustomerType').value,
                    status: document.getElementById('editStatus').value,
                    notes: document.getElementById('editNotes').value.trim(),
                    modifiedDate: new Date().toISOString().split('T')[0]
                };
                
                // データを更新
                customers[customerIndex] = updatedCustomer;
                filteredCustomers = [...customers];
                
                // テーブルとダッシュボードを更新
                updateCustomerTable();
                updateCustomerDashboard();
                
                // モーダルを閉じる
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
                modal.hide();
                
                // 成功メッセージ
                showNotification(`取引先「${updatedCustomer.companyName}」の情報を更新しました`, 'success');
                
                // LocalStorageに保存（あれば）
                try {
                    localStorage.setItem('castingCustomers', JSON.stringify(customers));
                } catch (error) {
                    console.warn('LocalStorage保存エラー:', error);
                }
            }
        }

        function deleteCustomer(id) {
            if (confirm('この取引先を削除しますか？')) {
                customers = customers.filter(c => c.id !== id);
                filteredCustomers = [...customers];
                updateCustomerTable();
                updateCustomerDashboard();
                showNotification('取引先を削除しました', 'success');
            }
        }

        // DOMContentLoaded後の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 製品・取引先データ初期化
            initializeProductData();
            initializeCustomerData();
            
            // 注文データ初期化
            filteredOrders = [...orders];
            updateDashboard();
            updateTable();
            
            // 製品・取引先ダッシュボード更新
            updateProductDashboard();
            updateProductTable();
            updateCustomerDashboard();
            updateCustomerTable();
            
            console.log('ステンレス鋳造管理システム完全版 起動完了');
            console.log('製品管理・取引先管理機能が追加されました');
        });
    </script>

</body>
</html>
